<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡¶æ ‡¶ú‡¶¨‡¶æ ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡¶ø‡¶ì - ‡¶¨‡¶ø‡¶≤‡¶ø‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™</title>
    
    <link rel="icon" href="favicon.ico"> 
    
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- NEW COLOR SCHEME (BLUE) --- */
        :root {
            --primary-color: #2980B9; /* Deep Blue (Primary) */
            --secondary-color: #1ABC9C; /* Turquoise/Cyan (Accent) */
            --bg-color: #f4f6f8;
            --text-color: #333;
            --white: #ffffff;
            --danger: #E74C3C;
            --success: #2ECC71;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Hind Siliguri', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ */
        header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 { font-size: 1.8rem; font-weight: 700; color: var(--secondary-color); }
        header p { font-size: 0.9rem; color: #fff; }

        /* ‡¶Æ‡ßá‡¶á‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ (‡¶°‡ßá‡¶∏‡ßç‡¶ï‡¶ü‡¶™ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶•) */
        .container {
            padding: 15px;
            max-width: 1100px; /* Increased width for desktop */
            margin: 0 auto;
        }

        /* ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .card {
            background: var(--white);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease-in-out;
        }

        /* ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        input:focus { outline: none; border-color: var(--primary-color); }

        /* ‡¶¨‡¶æ‡¶ü‡¶® */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-primary { background: var(--primary-color); color: var(--white); width: 100%; }
        .btn-secondary { background: var(--secondary-color); color: var(--white); width: 100%; }
        .btn-danger { background: var(--danger); color: var(--white); width: 100%; }
        .btn-warning { background: #f39c12; color: var(--white); width: 100%; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; }

        /* ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ (‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø) */
        .item-row { display: grid; grid-template-columns: 4fr 1fr 1.5fr 0.5fr; gap: 10px; margin-bottom: 8px; }
        .total-section { text-align: right; margin-top: 20px; border-top: 2px dashed #ddd; padding-top: 15px; }
        .total-amount { font-size: 1.5rem; color: var(--primary-color); font-weight: bold; }

        /* --- Top Tabs (Desktop Navigation) --- */
        .top-tabs-wrapper {
            background: var(--white);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .top-tabs {
            display: flex;
            overflow: hidden;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            cursor: pointer;
            color: var(--text-color);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .nav-item:hover {
            background-color: #f0f0f0;
        }
        .nav-item.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: #eaf3f9; /* Light background for active tab */
        }
        .nav-item i { font-size: 1rem; }
        .nav-item span { font-size: 0.9rem; }
        /* --- END: Top Tabs --- */

        /* ‡¶™‡ßá‡¶ú ‡¶≠‡¶ø‡¶â ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ */
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.1s;
        }
        .list-item:hover { background-color: #f9f9f9; }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .status-paid { background: #d4edda; color: #155724; }
        .status-due { background: #f8d7da; color: #721c24; }

        /* ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* PDF ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡¶≤‡ßá‡¶ü (‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã) */
        #pdf-template {
            display: none; 
            width: 100%;
            background: white;
            padding: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <header>
        <h1>‡¶Æ‡¶æ ‡¶ú‡¶¨‡¶æ ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡¶ø‡¶ì</h1>
        <p>‡¶™‡ßç‡¶∞‡ßã‡¶™‡¶æ‡¶á‡¶ü‡¶∞: ‡¶ú‡¶®‡¶ø ‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞</p>
        <p>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ‡¶π‡¶æ‡¶ú‡ßÄ ‡¶Ü‡¶É ‡¶∞‡¶π‡¶Æ‡¶æ‡¶® ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü, ‡¶®‡¶ø‡¶Æ‡¶∏‡¶æ‡¶∞, ‡¶¨‡ßÅ‡¶°‡¶º‡¶ø‡¶ö‡¶Ç, ‡¶ï‡ßÅ‡¶Æ‡¶ø‡¶≤‡ßç‡¶≤‡¶æ‡•§</p>
        <p><i class="fas fa-phone"></i> ‡ß¶‡ßß‡ßÆ‡ß¨‡ß™‡ßØ‡ß¨‡ßØ‡ßß‡ß©‡ßÆ</p>
    </header>

    <div class="top-tabs-wrapper">
        <div class="container">
            <div class="top-tabs">
                <div class="nav-item active" onclick="switchView('home-view', this)">
                    <i class="fas fa-calculator"></i>
                    <span>‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø</span>
                </div>
                <div class="nav-item" onclick="switchView('invoices-view', this)">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏</span>
                </div>
                <div class="nav-item" onclick="switchView('customers-view', this)">
                    <i class="fas fa-users"></i>
                    <span>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï</span>
                </div>
                <div class="nav-item" onclick="switchView('reports-view', this)">
                    <i class="fas fa-chart-line"></i>
                    <span>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</span>
                </div>
                <div class="nav-item" onclick="switchView('settings-view', this)">
                    <i class="fas fa-cog"></i>
                    <span>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        
        <div id="home-view" class="view-section active">
            <div class="card">
                <h3><i class="fas fa-file-invoice"></i> ‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø/‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <hr style="margin: 10px 0;">
                
                <div class="form-group">
                    <label>‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶®‡¶Ç:</label>
                    <input type="text" id="invoiceNo" readonly style="background: #eee;">
                </div>
                
                <div class="form-group">
                    <label>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</label>
                    <input type="text" id="customerName" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" list="customerList">
                    <datalist id="customerList"></datalist>
                </div>
                
                <div class="form-group">
                    <label>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</label>
                    <input type="tel" id="customerMobile" placeholder="01XXX...">
                </div>

                <div class="form-group">
                    <label>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</label>
                    <input type="text" id="customerAddress" placeholder="‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
                </div>
                
                <div class="form-group">
                    <label>‡¶™‡¶£‡ßç‡¶Ø‡¶∏‡¶Æ‡ßÇ‡¶π:</label>
                    <div id="items-container">
                        </div>
                    <button class="btn btn-secondary btn-sm" onclick="addNewItemRow()" style="margin-top: 5px; width: auto;">
                        <i class="fas fa-plus"></i> ‡¶Ü‡¶∞‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>

                <div class="total-section">
                    <p>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü: <span id="grandTotal">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                    <p>‡¶ú‡¶Æ‡¶æ: <input type="number" id="paidAmount" value="0" style="width: 100px; text-align: right;" oninput="calculateCalculations()"> ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                    <p style="color: var(--danger);">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: <span id="dueAmount">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                </div>

                <button class="btn btn-primary" onclick="saveInvoice()" style="margin-top: 15px;">
                    <i class="fas fa-save"></i> ‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶ì ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶®
                </button>
            </div>
        </div>

        <div id="invoices-view" class="view-section">
            <div class="card">
                <h3>‡¶∏‡¶ï‡¶≤ ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏</h3>
                <div id="invoice-list-container"></div>
            </div>
        </div>

        <div id="customers-view" class="view-section">
            <div class="card">
                <h3>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
                <div id="customer-list-container"></div>
            </div>
        </div>

        <div id="reports-view" class="view-section">
            <div class="card">
                <h3>‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡¶æ‡¶Ø‡¶º‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                    <select id="reportYearSelect" onchange="renderReports()" style="flex: 1;"></select>
                    <select id="reportMonthSelect" onchange="renderReports()" style="flex: 1;"></select>
                </div>
                <p style="font-size: 0.9rem; color: var(--primary-color); font-weight: 600; margin-bottom: 10px;">
                    <span id="report-period-text">‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</span>
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <div style="background: #eaf3f9; padding: 10px; border-radius: 5px; text-align: center;">
                        <h4 style="color: var(--primary-color); font-size: 0.9rem;">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º (‡ß≥)</h4>
                        <h2 id="total-sales-report" style="font-size: 1.4rem;">0</h2>
                    </div>
                    <div style="background: #e4f9f7; padding: 10px; border-radius: 5px; text-align: center;">
                        <h4 style="color: var(--secondary-color); font-size: 0.9rem;">‡¶Æ‡ßã‡¶ü ‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß (‡ß≥)</h4>
                        <h2 id="total-paid-report" style="font-size: 1.4rem;">0</h2>
                    </div>
                    <div style="background: #fbe6e6; padding: 10px; border-radius: 5px; text-align: center;">
                        <h4 style="color: var(--danger); font-size: 0.9rem;">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ (‡ß≥)</h4>
                        <h2 id="total-due-report" style="font-size: 1.4rem;">0</h2>
                    </div>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; text-align: center;">
                        <h4 style="color: #2196f3; font-size: 0.9rem;">‡¶Æ‡ßã‡¶ü ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏</h4>
                        <h2 id="total-invoices-report" style="font-size: 1.4rem;">0</h2>
                    </div>
                </div>

                <h4 style="margin-top: 25px; border-top: 1px solid #ddd; padding-top: 15px;">
                    <i class="fas fa-users"></i> ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (<span id="client-report-period-name">‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Æ‡¶Ø‡¶º</span>)
                </h4>
                <div id="client-report-container" style="margin-top: 10px;">
                    <p style="color:#777;">‡¶Æ‡¶æ‡¶∏ ‡¶¨‡¶æ ‡¶¨‡¶õ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡•§</p>
                </div>
                <h4 style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 15px;">‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶ó‡¶£ (‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ)</h4>
                <ul id="top-customers-list" style="list-style: none; margin-top: 10px;"></ul>
            </div>
        </div>
        
        <div id="settings-view" class="view-section">
            <div class="card">
                <h3><i class="fas fa-cog"></i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ì ‡¶°‡ßá‡¶ü‡¶æ</h3>
                <hr style="margin: 10px 0;">

                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-size: 1.1rem; color: var(--primary-color);">‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶°‡ßá‡¶ü‡¶æ üì•</label>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶¨‡¶ø‡¶≤ ‡¶ì ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø JSON ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <button class="btn btn-primary" onclick="exportBackupData()">
                        <i class="fas fa-download"></i> ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
                
                <hr style="margin: 20px 0;">
                
                <div class="form-group">
                    <label style="font-size: 1.1rem; color: var(--danger);">‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® üì§</label>
                    <p style="font-size: 0.85rem; color: #e74c3c; margin-bottom: 10px;">**‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ:** ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶≤‡ßá ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶ø‡¶§ ‡¶π‡¶¨‡ßá‡•§</p>
                    
                    <input type="file" id="restoreFile" accept=".json" style="padding: 5px; margin-bottom: 10px;">
                    <button class="btn btn-danger" onclick="importBackupData()">
                        <i class="fas fa-upload"></i> ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>

            </div>
        </div>

    </div>

    <div id="pdf-container" style="display: none;">
        <div id="invoice-template" style="padding: 20px; font-family: 'Hind Siliguri', sans-serif; background: #fff; width: 100%; max-width: 800px;">
            <div style="text-align: center; border-bottom: 2px solid #2980B9; padding-bottom: 10px; margin-bottom: 20px;">
                <h1 style="color: #2980B9; margin: 0; font-size: 28px;">‡¶Æ‡¶æ ‡¶ú‡¶¨‡¶æ ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡¶ø‡¶ì</h1>
                <p style="margin: 5px 0;">‡¶™‡ßç‡¶∞‡ßã‡¶™‡¶æ‡¶á‡¶ü‡¶∞: ‡¶ú‡¶®‡¶ø ‡¶∏‡¶∞‡¶ï‡¶æ‡¶∞</p>
                <p style="margin: 5px 0;">‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ: ‡¶π‡¶æ‡¶ú‡ßÄ ‡¶Ü‡¶É ‡¶∞‡¶π‡¶Æ‡¶æ‡¶® ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü, ‡¶®‡¶ø‡¶Æ‡¶∏‡¶æ‡¶∞, ‡¶¨‡ßÅ‡¶°‡¶º‡¶ø‡¶ö‡¶Ç, ‡¶ï‡ßÅ‡¶Æ‡¶ø‡¶≤‡ßç‡¶≤‡¶æ‡•§</p>
                <p style="margin: 0;"><b>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ‡ß¶‡ßß‡ßÆ‡ß¨‡ß™‡ßØ‡ß¨‡ßØ‡ßß‡ß©‡ßÆ</b></p>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <div>
                    <p><b>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</b> <span id="pdf-cust-name"></span></p>
                    <p><b>‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤:</b> <span id="pdf-cust-mobile"></span></p>
                    <p><b>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</b> <span id="pdf-cust-address"></span></p>
                </div>
                <div style="text-align: right;">
                    <p><b>‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶®‡¶Ç:</b> <span id="pdf-inv-no"></span></p>
                    <p><b>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</b> <span id="pdf-date"></span></p>
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                <thead>
                    <tr style="background: #2980B9; color: #fff;">
                        <th style="padding: 8px; border: 1px solid #ddd;">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">‡¶¶‡¶∞</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">‡¶Æ‡ßã‡¶ü</th>
                    </tr>
                </thead>
                <tbody id="pdf-items-body"></tbody>
            </table>

            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <table style="width: 250px;">
                    <tr>
                        <td style="text-align: right; padding: 5px;"><b>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤:</b></td>
                        <td style="text-align: right; padding: 5px;" id="pdf-total"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px;"><b>‡¶ú‡¶Æ‡¶æ:</b></td>
                        <td style="text-align: right; padding: 5px;" id="pdf-paid"></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding: 5px; color: #e74c3c;"><b>‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ:</b></td>
                        <td style="text-align: right; padding: 5px; color: #e74c3c;" id="pdf-due"></td>
                    </tr>
                </table>
            </div>

            <div style="margin-top: 50px; display: flex; justify-content: space-between;">
                <div style="text-align: center; width: 150px; border-top: 1px solid #333; padding-top: 5px;">
                    ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞
                </div>
                <div style="text-align: center; width: 150px; border-top: 1px solid #333; padding-top: 5px;">
                    ‡¶ï‡¶∞‡ßç‡¶§‡ßÉ‡¶™‡¶ï‡ßç‡¶∑‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ï‡ßç‡¶∑‡¶∞
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px; font-size: 10px; color: #777;">
                ‡¶∏‡¶´‡¶ü‡¶ì‡¶Ø‡¶º‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶≤‡ßç‡¶Ø‡ßÅ‡¶∂‡¶®
            </div>
        </div>
    </div>

    <script>
        // --- ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ---
        let db = {
            invoices: JSON.parse(localStorage.getItem('joba_invoices')) || [], /* Key set to joba_ */
            customers: JSON.parse(localStorage.getItem('joba_customers')) || [], /* Key set to joba_ */
            reports: JSON.parse(localStorage.getItem('joba_reports')) || {} /* Key set to joba_ */
        };
        
        // --- ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ (‡¶è‡¶°‡¶ø‡¶ü ‡¶∏‡ßç‡¶ü‡ßá‡¶ü) ---
        let currentEditingInvoiceId = null; 
        
        // ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ
        const MONTH_NAMES = [
            '‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¨‡¶õ‡¶∞', '‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø', '‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö', '‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤', '‡¶Æ‡ßá', '‡¶ú‡ßÅ‡¶®',
            '‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á', '‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü', '‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞', '‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞', '‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'
        ];


        // --- ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ---
        document.addEventListener('DOMContentLoaded', () => {
            generateInvoiceID();
            addNewItemRow(); // ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶∏‡¶æ‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
            loadCustomerDatalist();
            initializeReportPickers(); // ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ
            renderReports(); // ‡¶™‡ßç‡¶∞‡¶æ‡¶•‡¶Æ‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶≤‡ßã‡¶°
        });

        // --- ‡¶®‡ßç‡¶Ø‡¶æ‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ---
        function switchView(viewId, element) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            // ‡¶≠‡¶ø‡¶â ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
            if(viewId === 'invoices-view') renderInvoiceList();
            if(viewId === 'customers-view') renderCustomerList();
            if(viewId === 'reports-view') renderReports(); // ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶≠‡¶ø‡¶â‡¶§‡ßá ‡¶ó‡ßá‡¶≤‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
        }

        // --- ‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø/‡¶è‡¶°‡¶ø‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï ---
        function generateInvoiceID() {
            const today = new Date();
            const dateStr = today.toISOString().slice(0,10).replace(/-/g,'');
            const count = db.invoices.filter(inv => inv.date === today.toISOString().slice(0,10)).length + 1;
            const id = `MJS-${dateStr}-${String(count).padStart(3, '0')}`; /* ID prefix set to MJS- */
            document.getElementById('invoiceNo').value = id;
        }

        function addNewItemRow() {
            const container = document.getElementById('items-container');
            const div = document.createElement('div');
            div.className = 'item-row';
            div.innerHTML = `
                <input type="text" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ/‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" class="item-name">
                <input type="number" placeholder="Qty" class="item-qty" oninput="calculateCalculations()" value="1">
                <input type="number" placeholder="‡¶¶‡¶æ‡¶Æ" class="item-price" oninput="calculateCalculations()">
                <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculateCalculations()">X</button>
            `;
            container.appendChild(div);
        }

        function calculateCalculations() {
            let total = 0;
            const rows = document.querySelectorAll('.item-row');
            
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                total += (qty * price);
            });

            document.getElementById('grandTotal').innerText = total;
            
            const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
            const due = total - paid;
            document.getElementById('dueAmount').innerText = due;
            return { total, paid, due };
        }
        
        // ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶´‡¶∞‡ßç‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ
        function collectInvoiceData() {
            const customerName = document.getElementById('customerName').value;
            const customerMobile = document.getElementById('customerMobile').value;
            const customerAddress = document.getElementById('customerAddress').value; // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ
            const invoiceId = document.getElementById('invoiceNo').value;
            
            if(!customerName) { alert('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®'); return null; }
        
            const rows = document.querySelectorAll('.item-row');
            let items = [];
            rows.forEach(row => {
                const name = row.querySelector('.item-name').value;
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                if(name && (qty > 0 || price > 0)) {
                    items.push({ name, qty, price, total: qty * price });
                }
            });
        
            if(items.length === 0) { alert('‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®'); return null; }
        
            const calcs = calculateCalculations();
            const invoice = {
                id: invoiceId,
                date: new Date().toISOString().slice(0,10), 
                customerName,
                customerMobile,
                customerAddress, // ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
                items,
                total: calcs.total,
                paid: calcs.paid,
                due: calcs.due
            };
            return invoice;
        }


        // ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶≤ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function saveInvoice() {
            const invoice = collectInvoiceData();
            if (!invoice) return;

            // ‡¶∏‡ßá‡¶≠ ‡¶°‡ßá‡¶ü‡¶æ
            db.invoices.unshift(invoice);
            updateCustomerDue(invoice.customerName, invoice.customerMobile, invoice.due);
            updateReports(invoice.date, invoice.total, invoice.paid, invoice.due, true); // ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
            saveToLocalStorage();

            // PDF ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü
            generatePDF(invoice);

            alert('‡¶¨‡¶ø‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
            location.reload(); // ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§
        }

        // ‡¶è‡¶°‡¶ø‡¶ü ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ)
        function editInvoice(invoiceId) {
            const invoice = db.invoices.find(i => i.id === invoiceId);
            if (!invoice) {
                alert('‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§');
                return;
            }

            // ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            currentEditingInvoiceId = invoiceId;

            // ‡ßß. Home View-‡¶§‡ßá ‡¶Ø‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ
            switchView('home-view', document.querySelector('.nav-item[onclick*="\'home-view\'"]'));

            // ‡ß®. ‡¶´‡¶∞‡ßç‡¶Æ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ
            document.getElementById('invoiceNo').value = invoice.id; 
            document.getElementById('customerName').value = invoice.customerName;
            document.getElementById('customerMobile').value = invoice.customerMobile;
            document.getElementById('customerAddress').value = invoice.customerAddress || ''; // ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            
            // ‡ß©. ‡¶™‡¶£‡ßç‡¶Ø‡¶∏‡¶Æ‡ßÇ‡¶π ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
            const itemsContainer = document.getElementById('items-container');
            itemsContainer.innerHTML = ''; 

            invoice.items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <input type="text" placeholder="‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ/‡¶¨‡¶ø‡¶¨‡¶∞‡¶£" class="item-name" value="${item.name || ''}">
                    <input type="number" placeholder="Qty" class="item-qty" oninput="calculateCalculations()" value="${item.qty || 0}">
                    <input type="number" placeholder="‡¶¶‡¶æ‡¶Æ" class="item-price" oninput="calculateCalculations()" value="${item.price || 0}">
                    <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculateCalculations()">X</button>
                `;
                itemsContainer.appendChild(div);
            });

            if (invoice.items.length === 0) {
                addNewItemRow();
            }

            // ‡ß™. ‡¶Æ‡ßã‡¶ü ‡¶ì ‡¶ú‡¶Æ‡¶æ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ
            document.getElementById('paidAmount').value = invoice.paid;
            calculateCalculations(); 

            // ‡ß´. Save ‡¶¨‡¶æ‡¶ü‡¶®‡¶ï‡ßá Update ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ
            const saveButton = document.querySelector('#home-view button[onclick*="saveInvoice"]');
            saveButton.innerHTML = '<i class="fas fa-edit"></i> ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®';
            saveButton.setAttribute('onclick', 'updateInvoice()'); 
            saveButton.classList.remove('btn-primary');
            saveButton.classList.add('btn-warning');
        }

        // ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function updateInvoice() {
            if (!currentEditingInvoiceId) {
                alert('‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§');
                return;
            }

            const newInvoice = collectInvoiceData(); 
            if (!newInvoice) return; 

            const oldInvoiceIndex = db.invoices.findIndex(i => i.id === currentEditingInvoiceId);
            if (oldInvoiceIndex === -1) {
                alert('‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏‡¶ü‡¶ø ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶æ‡•§');
                return;
            }
            const oldInvoice = db.invoices[oldInvoiceIndex];
            
            // ‡ßß. ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ
            updateReports(oldInvoice.date, oldInvoice.total, oldInvoice.paid, oldInvoice.due, false); 

            // ‡ß®. ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ (totalDue) ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ
            const oldDue = oldInvoice.due;
            const newDue = newInvoice.due;
            
            let customer = db.customers.find(c => c.mobile === newInvoice.customerMobile);
            
            if (customer) {
                // ‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
                customer.totalDue = (customer.totalDue || 0) - oldDue;
                // ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                customer.totalDue = (customer.totalDue || 0) + newDue;
                customer.totalDue = Math.max(0, customer.totalDue); 
                customer.lastVisit = new Date().toISOString().slice(0,10);
            } else {
                // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶∞ ‡¶´‡¶≤‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º ‡¶è‡¶¨‡¶Ç ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
                db.customers.push({
                    name: newInvoice.customerName, mobile: newInvoice.customerMobile, totalDue: newDue, lastVisit: new Date().toISOString().slice(0,10)
                });
            }

            // ‡ß©. ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶® ‡¶ï‡¶∞‡¶æ
            db.invoices[oldInvoiceIndex] = newInvoice;
            
            // ‡ß™. ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
            updateReports(newInvoice.date, newInvoice.total, newInvoice.paid, newInvoice.due, true); 

            saveToLocalStorage();

            alert(`‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ${currentEditingInvoiceId} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
            
            // ‡ß´. ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶≠‡¶ø‡¶â ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°)
            generatePDF(newInvoice); 

            // ‡ß¨. ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßá ‡¶∏‡ßç‡¶ü‡ßá‡¶ü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            location.reload(); 
        }

        // --- ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ---
        function deleteInvoice(invoiceId) {
            if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶è‡¶á ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá‡•§')) {
                return;
            }

            const invoiceIndex = db.invoices.findIndex(i => i.id === invoiceId);
            if (invoiceIndex === -1) {
                alert('‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§');
                return;
            }

            const deletedInvoice = db.invoices[invoiceIndex];
            const dueAmount = deletedInvoice.due;
            const customerMobile = deletedInvoice.customerMobile;
            
            // ‡ßß. ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ
            updateReports(deletedInvoice.date, deletedInvoice.total, deletedInvoice.paid, deletedInvoice.due, false); 

            // ‡ß®. ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶á ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏‡ßá‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ
            let customer = db.customers.find(c => c.mobile === customerMobile);
            if (customer) {
                customer.totalDue = Math.max(0, (customer.totalDue || 0) - dueAmount);
            }

            // ‡ß©. ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
            db.invoices.splice(invoiceIndex, 1);
            
            // ‡ß™. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
            saveToLocalStorage();
            
            // ‡ß´. UI ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
            renderInvoiceList();
            renderReports();
            alert(`‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ${invoiceId} ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§`);
        }
        // --- ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ ---
        
        // --- ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ì ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
        function updateReports(dateStr, total, paid, due, isAdd) {
            // dateStr format is 'YYYY-MM-DD'
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(5, 7); // MM
            
            // ‡¶¨‡¶õ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ
            if (!db.reports[year]) db.reports[year] = {};
            if (!db.reports[year][month]) {
                db.reports[year][month] = { totalSales: 0, totalDue: 0, totalPaid: 0, totalInvoices: 0 };
            }
            
            // ‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ: ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ (1) ‡¶¨‡¶æ ‡¶∞‡¶ø‡¶≠‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ (-1)
            const multiplier = isAdd ? 1 : -1;
            
            // ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            db.reports[year][month].totalSales += total * multiplier;
            db.reports[year][month].totalDue += due * multiplier;
            db.reports[year][month].totalPaid += paid * multiplier;
            db.reports[year][month].totalInvoices += multiplier;

            // ‡¶®‡ßá‡¶ó‡ßá‡¶ü‡¶ø‡¶≠ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶è‡¶°‡¶º‡¶æ‡¶®‡ßã (‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞)
            db.reports[year][month].totalSales = Math.max(0, db.reports[year][month].totalSales);
            db.reports[year][month].totalDue = Math.max(0, db.reports[year][month].totalDue);
            db.reports[year][month].totalPaid = Math.max(0, db.reports[year][month].totalPaid);
            db.reports[year][month].totalInvoices = Math.max(0, db.reports[year][month].totalInvoices);

            // saveToLocalStorage() ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá
        }
        // --- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ ---


        // --- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ---
        function deleteCustomer(mobile) {
            if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶è‡¶á ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶ï‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶¨‡ßá‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶è‡¶á ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§')) {
                return;
            }

            const customerIndex = db.customers.findIndex(c => c.mobile === mobile);
            if (customerIndex === -1) {
                alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§');
                return;
            }

            // ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ø‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø ‡¶®‡¶æ
            const hasInvoices = db.invoices.some(inv => inv.customerMobile === mobile);
            if (hasInvoices) {
                alert('‡¶è‡¶á ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá ‡¶è‡¶ñ‡¶®‡¶ì ‡¶¨‡¶ø‡¶≤ ‡¶∞‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶°‡ßá‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶∏‡¶æ‡¶Æ‡¶û‡ßç‡¶ú‡¶∏‡ßç‡¶Ø‡¶§‡¶æ ‡¶è‡¶°‡¶º‡¶æ‡¶§‡ßá, ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶ó‡ßá ‡¶¨‡¶ø‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }
            
            // ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
            db.customers.splice(customerIndex, 1);
            
            saveToLocalStorage();
            
            // UI Refresh
            renderCustomerList();
            renderReports();
            loadCustomerDatalist();
            alert('‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§');
        }
        // --- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶∂‡ßá‡¶∑ ---


        function updateCustomerDue(name, mobile, dueAmount) {
            let customer = db.customers.find(c => c.mobile === mobile);
            if (customer) {
                customer.totalDue = (customer.totalDue || 0) + dueAmount;
                customer.lastVisit = new Date().toISOString().slice(0,10);
            } else {
                db.customers.push({
                    name, mobile, totalDue: dueAmount, lastVisit: new Date().toISOString().slice(0,10)
                });
            }
        }

        function loadCustomerDatalist() {
            const list = document.getElementById('customerList');
            list.innerHTML = '';
            db.customers.forEach(c => {
                const option = document.createElement('option');
                option.value = c.name;
                list.appendChild(option);
            });
            
            // ‡¶Ö‡¶ü‡ßã ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶´‡¶ø‡¶≤
            document.getElementById('customerName').addEventListener('change', function() {
                const cust = db.customers.find(c => c.name === this.value);
                if(cust) document.getElementById('customerMobile').value = cust.mobile;
            });
        }

        // --- PDF ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶∂‡¶® ---
        function generatePDF(invoice) {
            document.getElementById('pdf-cust-name').innerText = invoice.customerName;
            document.getElementById('pdf-cust-mobile').innerText = invoice.customerMobile;
            document.getElementById('pdf-cust-address').innerText = invoice.customerAddress || 'N/A';
            document.getElementById('pdf-inv-no').innerText = invoice.id;
            document.getElementById('pdf-date').innerText = invoice.date;

            const tbody = document.getElementById('pdf-items-body');
            tbody.innerHTML = '';
            invoice.items.forEach(item => {
                const itemTotal = parseFloat(item.qty) * parseFloat(item.price);

                tbody.innerHTML += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align:center">${item.qty}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align:right">${item.price}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align:right">${itemTotal}</td>
                    </tr>
                `;
            });

            document.getElementById('pdf-total').innerText = invoice.total + '/-';
            document.getElementById('pdf-paid').innerText = invoice.paid + '/-';
            document.getElementById('pdf-due').innerText = invoice.due + '/-';

            const element = document.getElementById('invoice-template');
            const opt = {
                margin: 0.5,
                filename: `Bill_${invoice.id}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            document.getElementById('pdf-container').style.display = 'block';
            html2pdf().set(opt).from(element).save().then(() => {
                document.getElementById('pdf-container').style.display = 'none';
            });
        }

        // --- ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ---
        function renderInvoiceList() {
            const container = document.getElementById('invoice-list-container');
            container.innerHTML = '';
            
            db.invoices.forEach(inv => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold">${inv.customerName}</div>
                        <div style="font-size:0.8rem; color:#666">${inv.id} | ${inv.date}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:bold">${inv.total} ‡¶ü‡¶æ‡¶ï‡¶æ</div>
                        <span class="status-badge ${inv.due > 0 ? 'status-due' : 'status-paid'}">
                            ${inv.due > 0 ? '‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ' + inv.due : '‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§'}
                        </span>
                        
                        <div style="margin-top: 5px;">
                            <button class="btn-sm btn-danger" style="margin-right: 5px;" onclick='deleteInvoice("${inv.id}")'>
                               <i class="fas fa-trash-alt"></i>
                            </button>
                            <button class="btn-sm btn-primary" style="margin-right: 5px;" onclick='rePrintInvoice("${inv.id}")'>
                               <i class="fas fa-print"></i>
                            </button>
                            <button class="btn-sm btn-secondary" onclick='editInvoice("${inv.id}")'>
                               <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function rePrintInvoice(id) {
            const inv = db.invoices.find(i => i.id === id);
            if(inv) generatePDF(inv);
        }

        // --- ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ---
        function renderCustomerList() {
            const container = document.getElementById('customer-list-container');
            container.innerHTML = '';
            
            db.customers.forEach(cust => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:bold">${cust.name}</div>
                        <div style="font-size:0.8rem; color:#666">${cust.mobile}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="color: var(--danger); font-weight:bold; margin-bottom: 5px;">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ${cust.totalDue}</div>
                        <button class="btn-sm btn-danger" onclick='deleteCustomer("${cust.mobile}")'>
                            <i class="fas fa-trash-alt"></i> ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // --- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ---
        function initializeReportPickers() {
            const yearSelect = document.getElementById('reportYearSelect');
            const monthSelect = document.getElementById('reportMonthSelect');
            const currentYear = new Date().getFullYear();
            
            // Year Picker (Go back 5 years or until first invoice year)
            yearSelect.innerHTML = `<option value="">‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Æ‡¶Ø‡¶º</option>`;
            
            const uniqueYears = new Set();
            db.invoices.forEach(inv => uniqueYears.add(parseInt(inv.date.substring(0, 4))));

            let startYear = currentYear;
            if (uniqueYears.size > 0) {
                startYear = Math.min(...Array.from(uniqueYears), currentYear);
            }
            
            for (let y = currentYear; y >= startYear; y--) {
                yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
            }
            
            // Month Picker
            monthSelect.innerHTML = '';
            MONTH_NAMES.forEach((name, index) => {
                if (index === 0) {
                    monthSelect.innerHTML += `<option value="">${name}</option>`;
                } else {
                    const monthValue = String(index).padStart(2, '0');
                    monthSelect.innerHTML += `<option value="${monthValue}">${name}</option>`;
                }
            });

            // Set default selection to the current month/year
            yearSelect.value = currentYear;
            monthSelect.value = String(new Date().getMonth() + 1).padStart(2, '0');
        }

        // --- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶∏ (‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá) ---
        function renderReports() {
            const yearSelect = document.getElementById('reportYearSelect').value;
            const monthSelect = document.getElementById('reportMonthSelect').value;
            const periodText = document.getElementById('report-period-text');
            const clientReportContainer = document.getElementById('client-report-container');
            const clientReportPeriodName = document.getElementById('client-report-period-name');


            let totalSales = 0;
            let totalDue = 0;
            let totalPaid = 0;
            let totalInvoices = 0;
            let periodName = '‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü';
            
            // ------------------------------------
            // ‡ßß. ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶ì ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶ó‡¶£‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ
            // ------------------------------------
            
            let filteredInvoices = db.invoices.filter(inv => {
                const invYear = inv.date.substring(0, 4);
                const invMonth = inv.date.substring(5, 7);
                
                let matchYear = (yearSelect === "" || invYear === yearSelect);
                let matchMonth = (monthSelect === "" || invMonth === monthSelect);
                
                return matchYear && matchMonth;
            });
            
            if (yearSelect === "" && monthSelect === "") {
                // ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ (‡¶™‡ßÅ‡¶∞‡ßã‡¶®‡ßã ‡¶≤‡¶ú‡¶ø‡¶ï)
                filteredInvoices.forEach(inv => {
                    totalSales += parseFloat(inv.total);
                    totalDue += parseFloat(inv.due);
                    totalPaid += parseFloat(inv.paid);
                    totalInvoices += 1;
                });
                periodName = '‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü';
                
            } else if (yearSelect !== "" && monthSelect === "") {
                // ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶¨‡¶õ‡¶∞‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (Report DB ‡¶•‡ßá‡¶ï‡ßá)
                const yearData = db.reports[yearSelect] || {};
                periodName = `${yearSelect} ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü`;
                
                for (const monthKey in yearData) {
                    totalSales += yearData[monthKey].totalSales;
                    totalDue += yearData[monthKey].totalDue;
                    totalPaid += yearData[monthKey].totalPaid;
                    totalInvoices += yearData[monthKey].totalInvoices;
                }

            } else if (yearSelect !== "" && monthSelect !== "") {
                // ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (Report DB ‡¶•‡ßá‡¶ï‡ßá)
                const monthData = db.reports[yearSelect] ? db.reports[yearSelect][monthSelect] : null;
                periodName = `${MONTH_NAMES[parseInt(monthSelect)]} ${yearSelect} ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü`;

                if (monthData) {
                    totalSales = monthData.totalSales;
                    totalDue = monthData.totalDue;
                    totalPaid = monthData.totalPaid;
                    totalInvoices = monthData.totalInvoices;
                }
            }
            
            // --- ‡ß®. ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ UI-‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ï‡¶∞‡¶æ ---
            periodText.innerText = periodName;
            document.getElementById('total-sales-report').innerText = totalSales.toFixed(2) + ' ‡ß≥'; 
            document.getElementById('total-due-report').innerText = totalDue.toFixed(2) + ' ‡ß≥';
            document.getElementById('total-paid-report').innerText = totalPaid.toFixed(2) + ' ‡ß≥';
            document.getElementById('total-invoices-report').innerText = totalInvoices;

            
            // ------------------------------------
            // ‡ß©. ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü (Client-wise Report)
            // ------------------------------------
            
            clientReportContainer.innerHTML = '';
            clientReportPeriodName.innerText = periodName.replace(' ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü', '').replace('‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü', '‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Æ‡¶Ø‡¶º');

            if (yearSelect === "" && monthSelect === "") {
                clientReportContainer.innerHTML = '<p style="color:#777;">‡¶Æ‡¶æ‡¶∏ ‡¶¨‡¶æ ‡¶¨‡¶õ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡•§</p>';
                
            } else if (filteredInvoices.length === 0) {
                clientReportContainer.innerHTML = '<p style="color:#e74c3c;">‡¶è‡¶á ‡¶Æ‡¶æ‡¶∏/‡¶¨‡¶õ‡¶∞‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶á‡¶®‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
                
            } else {
                // ‡ß©.‡ßß. ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡¶§‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ (Aggregation)
                const clientData = {};
                
                filteredInvoices.forEach(inv => {
                    const mobile = inv.customerMobile || inv.customerName; // Use mobile or name as unique key
                    if (!clientData[mobile]) {
                        clientData[mobile] = {
                            name: inv.customerName,
                            mobile: inv.customerMobile,
                            totalPurchase: 0,
                            totalPaid: 0,
                            totalDue: 0,
                            totalInvoices: 0
                        };
                    }
                    
                    clientData[mobile].totalPurchase += parseFloat(inv.total);
                    clientData[mobile].totalPaid += parseFloat(inv.paid);
                    clientData[mobile].totalDue += parseFloat(inv.due);
                    clientData[mobile].totalInvoices += 1;
                });

                // ‡ß©.‡ß®. ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá UI-‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ï‡¶∞‡¶æ
                let html = '<div style="overflow-x: auto;"><table style="width:100%; min-width: 550px; border-collapse: collapse;">';
                html += `
                    <thead>
                        <tr style="background-color:#2980B9; color: white;">
                            <th style="padding: 10px 8px; border: 1px solid #ddd; text-align: left; font-size: 0.9rem;">‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶®‡¶æ‡¶Æ/‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤</th>
                            <th style="padding: 10px 8px; border: 1px solid #ddd; text-align: right; font-size: 0.9rem;">‡¶Æ‡ßã‡¶ü ‡¶ï‡ßç‡¶∞‡¶Ø‡¶º</th>
                            <th style="padding: 10px 8px; border: 1px solid #ddd; text-align: right; font-size: 0.9rem;">‡¶ú‡¶Æ‡¶æ</th>
                            <th style="padding: 10px 8px; border: 1px solid #ddd; text-align: right; font-size: 0.9rem;">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</th>
                            <th style="padding: 10px 8px; border: 1px solid #ddd; text-align: center; font-size: 0.9rem;">‡¶¨‡¶ø‡¶≤</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                const sortedClientData = Object.values(clientData).sort((a, b) => b.totalPurchase - a.totalPurchase);

                sortedClientData.forEach(client => {
                    html += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">
                                <span style="font-weight: 600;">${client.name}</span>
                                <br><span style="font-size: 0.75rem; color: #777;">${client.mobile || 'N/A'}</span>
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${client.totalPurchase.toFixed(2)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${client.totalPaid.toFixed(2)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: ${client.totalDue > 0 ? 'var(--danger)' : '#000'}">
                                ${client.totalDue.toFixed(2)}
                            </td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${client.totalInvoices}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                clientReportContainer.innerHTML = html;
            }


            // --- ‡ß™. ‡¶∂‡ßÄ‡¶∞‡ßç‡¶∑ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï (‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ) ---
            const topCustList = document.getElementById('top-customers-list');
            topCustList.innerHTML = '';
            
            // ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
            const sortedCustomers = db.customers
                .sort((a, b) => (b.totalDue || 0) - (a.totalDue || 0))
                .slice(0, 5); 

            sortedCustomers.forEach(cust => {
                topCustList.innerHTML += `
                    <li style="padding:8px 5px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items: center;">
                        <div style="display: block;">
                            <span style="font-weight: 500;">${cust.name}</span>
                            <span style="font-size: 0.75rem; color: #777; display: block;">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: ${cust.mobile}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-weight: bold; color: var(--danger); margin-right: 10px;">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ: ${cust.totalDue}</span>
                            <button class="btn-sm btn-danger" onclick='deleteCustomer("${cust.mobile}")'>
                               <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </li>
                `;
            });
        }
        
        // --- ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü (‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™) ---
        function exportBackupData() {
            const backupData = {
                app_version: "1.0.0",
                backup_created_at: new Date().toISOString(),
                all_items: {
                    invoices: db.invoices,
                    customers: db.customers,
                    reports: db.reports 
                },
                deleted_items: { 
                    invoices: [],
                    customers: []
                },
                settings: {},
                flags: {}
            };

            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'joba_studio_backup_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert('‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: joba_studio_backup_data.json');
        }

        // --- ‡¶°‡ßá‡¶ü‡¶æ ‡¶á‡¶Æ‡¶™‡ßã‡¶∞‡ßç‡¶ü (‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞) ---
        function importBackupData() {
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø "backup_data.json" ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                return;
            }

            if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶ø‡¶§ ‡¶π‡¶¨‡ßá‡•§')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const backupData = JSON.parse(event.target.result);

                    if (!backupData.all_items || !backupData.all_items.invoices || !backupData.all_items.customers) {
                        alert('‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ó‡¶†‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º‡•§ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶æ‡•§');
                        return;
                    }

                    db.invoices = backupData.all_items.invoices;
                    db.customers = backupData.all_items.customers;
                    db.reports = backupData.all_items.reports || {}; 
                    
                    saveToLocalStorage();
                    
                    alert('‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶π ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§');
                    location.reload(); 
                    
                } catch (e) {
                    console.error(e);
                    alert('JSON ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶¨‡¶æ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶®‡¶∑‡ßç‡¶ü ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§');
                }
            };
            
            reader.readAsText(file);
        }

        // --- ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞ ---
        function saveToLocalStorage() {
            /* Keys changed to 'joba_' */
            localStorage.setItem('joba_invoices', JSON.stringify(db.invoices));
            localStorage.setItem('joba_customers', JSON.stringify(db.customers));
            localStorage.setItem('joba_reports', JSON.stringify(db.reports)); 
        }
    </script>
</body>
</html>