<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>মা জবা স্টুডিও - বিলিং অ্যাপ</title>

    <link rel="icon" href="favicon.ico">

    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #0f172a;
            --primary-light: #1e293b;
            --accent: #6366f1;
            /* Modern Indigo/Violet */
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: rgba(226, 232, 240, 0.6);
            --radius-xl: 32px;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
            --glass: blur(16px) saturate(180%);
        }

        [data-theme="dark"] {
            --primary: #f8fafc;
            --primary-light: #e2e8f0;
            --bg: #020617;
            --card-bg: rgba(15, 23, 42, 0.85);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(30, 41, 59, 0.6);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --accent-glow: rgba(99, 102, 241, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Hind Siliguri', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg);
            background-image:
                radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.03) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(5, 150, 105, 0.03) 0px, transparent 50%);
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            background: var(--bg);
            padding: 5rem 1rem 8rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -10%;
            width: 120%;
            height: 150%;
            background: radial-gradient(circle at center, var(--accent-glow) 0%, transparent 70%);
            z-index: 0;
            filter: blur(80px);
        }

        header h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            letter-spacing: -0.05em;
            background: linear-gradient(to right, var(--text-main), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
        }

        header p {
            font-size: 1.25rem;
            color: var(--text-muted);
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            font-weight: 500;
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(15deg);
        }

        /* --- Container --- */
        .container {
            max-width: 100%;
            margin: -4rem auto 4rem;
            padding: 0 2rem;
            position: relative;
            z-index: 10;
        }

        /* --- Navigation --- */
        .top-tabs-wrapper {
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            margin-bottom: 3rem;
            box-shadow: var(--shadow-lg);
            padding: 0.75rem;
            position: sticky;
            top: 1.5rem;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            min-width: 120px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-radius: var(--radius-lg);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-muted);
            font-weight: 700;
            gap: 0.75rem;
        }

        .nav-item:hover {
            background: rgba(99, 102, 241, 0.05);
            color: var(--accent);
        }

        .nav-item.active {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 8px 16px -4px var(--accent-glow);
            transform: translateY(-2px);
        }

        /* --- Card --- */
        .card {
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass);
            border-radius: var(--radius-xl);
            padding: 3rem;
            margin-bottom: 3rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            animation: cardEnter 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes cardEnter {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card h3 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            letter-spacing: -0.02em;
        }

        /* --- Forms --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .form-group {
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.85rem 1.25rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: var(--bg);
            transition: all 0.3s;
            color: var(--text-main);
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card-bg);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        /* --- Items Table --- */
        .item-row {
            display: grid;
            grid-template-columns: 1fr 100px 140px 50px;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
            padding: 1rem;
            background: var(--bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        /* --- Buttons --- */
        .btn {
            padding: 0.85rem 1.75rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            letter-spacing: -0.01em;
        }

        .btn-primary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 25px var(--accent-glow);
        }

        .btn-primary:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(4px);
            color: var(--text-main);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #fef2f2;
            color: var(--danger);
            border: 1.5px solid #fee2e2;
        }

        [data-theme="dark"] .btn-danger {
            background: rgba(220, 38, 38, 0.1);
            border-color: rgba(220, 38, 38, 0.2);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        /* --- Total Section --- */
        .total-section {
            background: var(--bg);
            border-radius: var(--radius-md);
            padding: 2rem;
            margin-top: 3rem;
            border: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 350px;
            align-items: center;
            font-weight: 600;
        }

        .total-row.grand-total {
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--primary);
            border-top: 2px dashed var(--border);
            padding-top: 1rem;
            margin-top: 0.5rem;
        }

        /* --- Lists --- */
        .list-item {
            background: var(--card-bg);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .list-item:hover {
            border-color: var(--accent);
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 800;
        }

        .status-paid {
            background: #dcfce7;
            color: #166534;
        }

        .status-due {
            background: #fee2e2;
            color: #991b1b;
        }

        /* --- View Sections --- */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .view-section.active {
            display: block;
            opacity: 1;
        }

        /* --- Stats Card --- */
        .stat-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent);
            opacity: 0.5;
        }

        /* --- Chart Container --- */
        .chart-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        /* --- Mobile --- */
        /* --- Layout & Sidebar --- */
        .main-layout {
            display: flex;
            min-height: 100vh;
            background: var(--bg);
        }

        .sidebar {
            width: 290px;
            background: var(--card-bg);
            backdrop-filter: var(--glass);
            border-right: 1px solid var(--border);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.02);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 0 2rem 2rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo i {
            font-size: 2.5rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 6px var(--accent-glow));
        }

        .sidebar-logo div {
            font-weight: 900;
            font-size: 1.75rem;
            color: var(--primary);
            letter-spacing: -0.06em;
            text-transform: uppercase;
        }

        .main-content {
            flex: 1;
            margin-left: 290px;
            width: calc(100% - 290px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar .nav-items-container {
            flex: 1;
            padding: 0 1rem;
        }

        .sidebar .nav-item {
            justify-content: flex-start;
            padding: 1.15rem 1.5rem;
            margin: 0.5rem 0;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .sidebar .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 0;
            background: var(--accent);
            border-radius: 0 4px 4px 0;
            transition: height 0.3s;
        }

        .sidebar .nav-item:hover {
            background: rgba(99, 102, 241, 0.08);
            color: var(--accent);
            padding-left: 1.75rem;
        }

        .sidebar .nav-item.active {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 8px 20px -6px var(--accent-glow);
        }

        .sidebar .nav-item.active::before {
            height: 60%;
            background: white;
        }

        .sidebar .nav-item i {
            width: 24px;
            text-align: center;
            font-size: 1.25rem;
        }

        .sidebar-footer {
            padding: 1.5rem;
            margin: 1rem;
            background: var(--bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            text-align: center;
        }

        .sidebar-footer p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .sidebar-footer .btn-sm {
            width: 100%;
            font-size: 0.8rem;
            padding: 0.6rem;
        }

        /* --- Mobile --- */
        @media (max-width: 1100px) {
            .sidebar {
                width: 90px;
                padding: 2.5rem 0.5rem;
            }

            .sidebar-logo {
                padding: 0 0 2rem;
                justify-content: center;
                border-bottom: none;
            }

            .sidebar-logo div {
                display: none;
            }

            .sidebar .nav-item span {
                display: none;
            }

            .sidebar .nav-item {
                justify-content: center;
                padding: 1.25rem;
                margin: 0.5rem;
            }

            .main-content {
                margin-left: 90px;
                width: calc(100% - 90px);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: 75px;
                bottom: 0;
                left: 0;
                top: auto;
                flex-direction: row;
                padding: 0;
                border-right: none;
                border-top: 1px solid var(--border);
                position: fixed;
            }

            .sidebar-logo {
                display: none;
            }

            .sidebar .nav-item {
                flex: 1;
                flex-direction: column;
                margin: 0;
                border-radius: 0;
                gap: 4px;
                font-size: 0.7rem;
            }

            .sidebar .nav-item span {
                display: block;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding-bottom: 80px;
            }

            header h1 {
                font-size: 2.5rem;
            }

            .container {
                padding: 0 1.25rem;
            }
        }

        /* --- Stats Mini Grid --- */
        .stats-mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-mini-card {
            background: var(--bg);
            padding: 1.25rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-mini-card h4 {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .stat-mini-card p {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--primary);
        }

        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .export-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .btn-sm-icon {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
    </style>


</head>

<body>

    <div class="main-layout">
        <div class="sidebar">
            <div class="sidebar-logo">
                <i class="fas fa-crown"></i>
                <div>MA JOBA</div>
            </div>
            <div class="nav-items-container">
                <div class="nav-item active" onclick="switchView('home-view', this)">
                    <i class="fas fa-plus-circle"></i>
                    <span>বিল তৈরি</span>
                </div>
                <div class="nav-item" onclick="switchView('invoices-view', this)">
                    <i class="fas fa-receipt"></i>
                    <span>সকল ইনভয়েস</span>
                </div>
                <div class="nav-item" onclick="switchView('customers-view', this)">
                    <i class="fas fa-user-group"></i>
                    <span>গ্রাহক তালিকা</span>
                </div>
                <div class="nav-item" onclick="switchView('reports-view', this)">
                    <i class="fas fa-chart-pie"></i>
                    <span>রিপোর্ট</span>
                </div>
                <div class="nav-item" onclick="switchView('dues-view', this)">
                    <i class="fas fa-hand-holding-dollar"></i>
                    <span>বকেয়া লিস্ট</span>
                </div>
                <div class="nav-item" onclick="switchView('settings-view', this)">
                    <i class="fas fa-sliders"></i>
                    <span>সেটিংস</span>
                </div>
            </div>

            <div class="sidebar-footer">
                <p>সাহায্য প্রয়োজন?</p>
                <button class="btn btn-secondary btn-sm" onclick="alert('সাপোর্ট টিম শীঘ্রই যোগাযোগ করবে।')">
                    <i class="fas fa-headset"></i> সাপোর্ট পান
                </button>
            </div>
        </div>

        <div class="main-content">
            <header>
                <button class="theme-toggle" onclick="toggleTheme()" title="থিম পরিবর্তন করুন">
                    <i class="fas fa-moon"></i>
                </button>
                <div style="position: relative; z-index: 2;">
                    <h1 id="display-shop-name">মা জবা স্টুডিও</h1>
                    <div
                        style="display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap; margin-top: 1rem;">
                        <span style="color: var(--text-muted);"><i class="fas fa-user-tie"></i> <span
                                id="display-proprietor">জনি সরকার</span></span>
                        <span style="color: var(--text-muted);"><i class="fas fa-phone"></i> <span
                                id="display-phone">০১৮৬৪৯৬৯১৩৮</span></span>
                        <span style="color: var(--text-muted);"><i class="fas fa-map-marker-alt"></i> <span
                                id="display-address">হাজী আঃ রহমান সুপার মার্কেট, নিমসার, বুড়িচং,
                                কুমিল্লা।</span></span>
                    </div>
                </div>
            </header>

            <div class="container">

                <div id="home-view" class="view-section active">
                    <div class="card">
                        <h3><i class="fas fa-file-invoice"></i> নতুন বিল তৈরি করুন</h3>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>ইনভয়েস নং (অটো):</label>
                                <input type="text" id="invoiceNo" readonly>
                            </div>
                            <div class="form-group">
                                <label>ইনভয়েস তারিখ:</label>
                                <input type="date" id="invoiceDate">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>গ্রাহকের নাম:</label>
                                <input type="text" id="customerName" placeholder="নাম লিখুন" list="customerList"
                                    oninput="handleCustomerSelection(this.value)">
                                <datalist id="customerList"></datalist>
                            </div>
                            <div class="form-group">
                                <label>মোবাইল নম্বর:</label>
                                <input type="tel" id="customerMobile" placeholder="যেমন: 01700000000">
                            </div>
                            <div class="form-group">
                                <label>ঠিকানা:</label>
                                <input type="text" id="customerAddress" placeholder="যেমন: নিমসার, কুমিল্লা">
                            </div>
                        </div>

                        <div
                            style="margin: 2rem 0 1rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                            <h4 style="color: var(--primary); font-size: 1rem;"><i class="fas fa-list-check"></i> পণ্যের
                                বিবরণ
                            </h4>
                        </div>

                        <div id="items-container">
                            <!-- Rows will be added here -->
                        </div>

                        <button class="btn btn-secondary btn-sm" onclick="addNewItemRow()" style="margin-bottom: 2rem;">
                            <i class="fas fa-plus"></i> আরো পণ্য যোগ করুন
                        </button>

                        <div class="total-section">
                            <div class="total-row">
                                <span>মোট বিল:</span>
                                <span id="grandTotalDisplay">0.00</span>
                            </div>
                            <div class="total-row">
                                <span>জমা:</span>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <input type="number" id="paidAmount" value="0"
                                        style="width: 120px; padding: 0.5rem; text-align: right;"
                                        oninput="calculateCalculations()">
                                </div>
                            </div>
                            <div class="total-row grand-total">
                                <span>বকেয়া:</span>
                                <span id="dueAmount" class="due-amount">0.00</span>
                            </div>
                        </div>

                        <div style="margin-top: 2rem;">
                            <button id="save-btn" class="btn btn-primary btn-full" onclick="saveInvoice()">
                                <i class="fas fa-cloud-arrow-up"></i> বিল সেভ করুন ও প্রিন্ট দিন
                            </button>
                            <button id="cancel-edit-btn" class="btn btn-secondary btn-full"
                                style="display:none; margin-top: 0.5rem;" onclick="resetBillForm()">
                                <i class="fas fa-times"></i> বাতিল করুন
                            </button>
                        </div>
                    </div>
                </div>


                <div id="invoices-view" class="view-section">
                    <div class="card">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h3 style="margin-bottom:0;"><i class="fas fa-file-lines"></i> সকল ইনভয়েস</h3>
                            <div class="export-buttons">
                                <button class="btn btn-secondary btn-sm-icon" onclick="exportInvoices('excel')">
                                    <i class="fas fa-file-excel" style="color: #166534;"></i> Excel
                                </button>
                                <button class="btn btn-secondary btn-sm-icon" onclick="exportInvoices('csv')">
                                    <i class="fas fa-file-csv" style="color: #2563eb;"></i> CSV
                                </button>
                                <button class="btn btn-secondary btn-sm-icon" onclick="window.print()">
                                    <i class="fas fa-print"></i> Print View
                                </button>
                            </div>
                        </div>

                        <div class="stats-mini-grid">
                            <div class="stat-mini-card">
                                <h4>আজকের মোট</h4>
                                <p id="stats-today-total">0.00 ৳</p>
                            </div>
                            <div class="stat-mini-card">
                                <h4>চলতি মাস</h4>
                                <p id="stats-month-total">0.00 ৳</p>
                            </div>
                            <div class="stat-mini-card">
                                <h4>মোট বকেয়া</h4>
                                <p id="stats-total-due" style="color: var(--danger);">0.00 ৳</p>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="form-group">
                                <label>অনুসন্ধান</label>
                                <input type="text" id="invoiceSearch" placeholder="নং বা নাম খুঁজুন..."
                                    oninput="renderInvoiceList()">
                            </div>
                            <div class="form-group">
                                <label>তারিখ থেকে</label>
                                <input type="date" id="filter-date-from" onchange="renderInvoiceList()">
                            </div>
                            <div class="form-group">
                                <label>তারিখ পর্যন্ত</label>
                                <input type="date" id="filter-date-to" onchange="renderInvoiceList()">
                            </div>
                            <div class="form-group">
                                <label>পেমেন্ট স্ট্যাটাস</label>
                                <select id="filter-status" onchange="renderInvoiceList()">
                                    <option value="all">সবগুলো</option>
                                    <option value="paid">পরিশোধিত</option>
                                    <option value="due">বকেয়া</option>
                                </select>
                            </div>
                        </div>

                        <div id="invoice-list-container" class="list-container"></div>
                    </div>
                </div>

                <div id="customers-view" class="view-section">
                    <div class="card">
                        <h3><i class="fas fa-user-tag"></i> গ্রাহক তালিকা ও বকেয়া</h3>
                        <div class="form-group">
                            <input type="text" id="customerSearch" placeholder="নাম বা মোবাইল দিয়ে খুঁজুন..."
                                oninput="renderCustomerList()">
                        </div>
                        <div id="customer-list-container" class="list-container"></div>
                    </div>
                </div>

                <div id="reports-view" class="view-section">
                    <div class="card">
                        <h3><i class="fas fa-chart-column"></i> ব্যবসায়িক রিপোর্ট</h3>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>বছর নির্বাচন করুন:</label>
                                <select id="reportYearSelect" onchange="renderReports()"></select>
                            </div>
                            <div class="form-group">
                                <label>মাস নির্বাচন করুন:</label>
                                <select id="reportMonthSelect" onchange="renderReports()"></select>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <h4>মোট বিক্রয়</h4>
                                <h2 id="total-sales-report">0.00 ৳</h2>
                                <div id="avg-invoice-val"
                                    style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                                    গড় বিল: 0.00 ৳</div>
                            </div>
                            <div class="stat-card">
                                <h4>মোট পরিশোধ</h4>
                                <h2 id="total-paid-report" style="color: var(--success);">0.00 ৳</h2>
                                <div id="paid-percentage"
                                    style="font-size: 0.8rem; color: var(--success); margin-top: 5px;">
                                    পরিশোধ হার: 0%</div>
                            </div>
                            <div class="stat-card">
                                <h4>মোট বকেয়া</h4>
                                <h2 id="total-due-report" style="color: var(--danger);">0.00 ৳</h2>
                                <div id="overdue-count"
                                    style="font-size: 0.8rem; color: var(--danger); margin-top: 5px;">বকেয়া
                                    বিল: 0 টি</div>
                            </div>
                            <div class="stat-card">
                                <h4>মোট ইনভয়েস</h4>
                                <h2 id="total-invoices-report">0</h2>
                                <div id="total-items-sold"
                                    style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">বিক্রিত পণ্য:
                                    0 টি
                                </div>
                            </div>
                        </div>

                        <div class="chart-container"
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; background: none; border: none; padding: 0;">
                            <div
                                style="background: var(--card-bg); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border);">
                                <h4><i class="fas fa-chart-line"></i> বিক্রয় ট্রেন্ড</h4>
                                <div style="height: 250px;"><canvas id="salesChart"></canvas></div>
                            </div>
                            <div
                                style="background: var(--card-bg); padding: 1.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border);">
                                <h4><i class="fas fa-chart-pie"></i> পরিশোধ বনাম বকেয়া</h4>
                                <div style="height: 250px;"><canvas id="statusChart"></canvas></div>
                            </div>
                        </div>

                        <div style="margin-top: 3rem;">
                            <h4 style="margin-bottom: 1.5rem;"><i class="fas fa-file-invoice-dollar"></i> বিস্তারিত
                                ইনভয়েস
                                রিপোর্ট
                                (<span id="report-period-label">সম্পূর্ণ সময়</span>)
                            </h4>
                            <div id="detailed-invoice-report-container"
                                style="overflow-x: auto; background: var(--card-bg); border-radius: var(--radius-md); border: 1px solid var(--border);">
                            </div>
                        </div>

                        <div
                            style="margin-top: 3rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                            <div>
                                <h4 style="margin-bottom: 1.5rem;"><i class="fas fa-users-viewfinder"></i> গ্রাহকভিত্তিক
                                    রিপোর্ট
                                </h4>
                                <div id="client-report-container" style="overflow-x: auto;"></div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1.5rem;"><i class="fas fa-box"></i> পণ্যভিত্তিক সারসংক্ষেপ
                                </h4>
                                <div id="product-summary-container" style="overflow-x: auto;"></div>
                            </div>
                        </div>

                        <div style="margin-top: 3rem;">
                            <h4 style="margin-bottom: 1rem;"><i class="fas fa-crown"></i> শীর্ষ ৫ বকেয়া গ্রাহক</h4>
                            <div id="top-customers-list" class="list-container"></div>
                        </div>
                    </div>
                </div>

                <div id="dues-view" class="view-section">
                    <div class="card">
                        <h3><i class="fas fa-hand-holding-dollar"></i> মাসিক বকেয়া লিস্ট</h3>

                        <div class="form-grid" style="margin-bottom: 2rem;">
                            <div class="form-group">
                                <label>বছর:</label>
                                <select id="dueYearSelect" onchange="renderDueList()"></select>
                            </div>
                            <div class="form-group">
                                <label>মাস:</label>
                                <select id="dueMonthSelect" onchange="renderDueList()"></select>
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn btn-primary" onclick="exportDueListPDF()" style="width: 100%;">
                                    <i class="fas fa-file-pdf"></i> PDF এক্সপোর্ট করুন
                                </button>
                            </div>
                        </div>

                        <div id="due-list-content" style="overflow-x: auto;">
                            <!-- Table will be rendered here -->
                        </div>
                    </div>
                </div>

                <div id="settings-view" class="view-section">
                    <div class="card">
                        <h3><i class="fas fa-store"></i> দোকানের তথ্য সেটিংস</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>দোকানের নাম:</label>
                                <input type="text" id="set-shop-name" placeholder="মা জবা স্টুডিও">
                            </div>
                            <div class="form-group">
                                <label>প্রোপাইটর:</label>
                                <input type="text" id="set-proprietor" placeholder="জনি সরকার">
                            </div>
                            <div class="form-group">
                                <label>মোবাইল নম্বর:</label>
                                <input type="tel" id="set-phone" placeholder="০১৮XXXXXXXX">
                            </div>
                            <div class="form-group">
                                <label>ইমেইল:</label>
                                <input type="email" id="set-email" placeholder="email@example.com">
                            </div>
                            <div class="form-group">
                                <label>ওয়েবসাইট:</label>
                                <input type="text" id="set-website" placeholder="www.yourstudio.com">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>ঠিকানা:</label>
                                <input type="text" id="set-address" placeholder="নিমসার, বুড়িচং, কুমিল্লা।">
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-barcode"></i> ইনভয়েস নাম্বারিং ও তারিখ</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>ইনভয়েস প্রিফিক্স (Prefix):</label>
                                <input type="text" id="set-prefix" placeholder="MJS-">
                            </div>
                            <div class="form-group">
                                <label>বিলিং তারিখ (Default):</label>
                                <select id="set-date-type">
                                    <option value="today">আজকের তারিখ</option>
                                    <option value="manual">ম্যানুয়াল</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>পেমেন্ট মেয়াদ (Due Days):</label>
                                <select id="set-due-days">
                                    <option value="0">একই দিন (Same Day)</option>
                                    <option value="7">৭ দিন</option>
                                    <option value="15">১৫ দিন</option>
                                    <option value="30">৩০ দিন</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-wand-magic-sparkles"></i> ডিজাইন ও প্রিন্ট লেআউট</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>লোগো আপলোড (Square Recommended):</label>
                                <input type="file" id="set-logo-input" accept="image/*"
                                    onchange="handleLogoUpload(this)">
                                <div id="logo-preview-container" style="margin-top: 10px; display: none;">
                                    <img id="logo-preview-img"
                                        style="max-height: 100px; border: 1px solid var(--border); border-radius: 8px;">
                                    <button class="btn btn-danger btn-sm" onclick="removeLogo()"
                                        style="margin-top: 5px; display: block;">মুছে ফেলুন</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>টেমপ্লেট স্টাইল:</label>
                                <select id="set-template-style">
                                    <option value="classic">Classic (ক্ল্যাসিক)</option>
                                    <option value="modern">Modern (মর্ডান)</option>
                                    <option value="minimal">Minimal (মিনিমাল)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>পেজ সাইজ:</label>
                                <select id="set-paper-size">
                                    <option value="a4">A4 (Standard)</option>
                                    <option value="letter">Letter</option>
                                    <option value="thermal">Thermal (৮০মিমি)</option>
                                </select>
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>হেডার টেক্সট (Custom):</label>
                                <input type="text" id="set-header-text" placeholder="যেমন: আপনার আস্থার প্রতীক">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label>ফুটার টেক্সট (Notes):</label>
                                <textarea id="set-footer-text" rows="2"
                                    placeholder="যেমন: বিক্রিত মাল ফেরত নেওয়া হয় না।"></textarea>
                            </div>
                        </div>

                        <button class="btn btn-primary btn-full" onclick="updateShopSettings()">
                            <i class="fas fa-save"></i> সকল সেটিংস সেভ করুন
                        </button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-box-archive"></i> পণ্য/সার্ভিস ম্যানেজমেন্ট</h3>
                        <div class="form-grid">
                            <div class="form-group" style="grid-column: span 2;">
                                <label>পণ্যের নাম:</label>
                                <input type="text" id="new-item-name" placeholder="পণ্যের নাম লিখুন">
                            </div>
                            <div class="form-group">
                                <label>ডিফল্ট দর (Price):</label>
                                <input type="number" id="new-item-price" placeholder="0.00">
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="addNewProductToMaster()">
                            <i class="fas fa-plus"></i> নতুন পণ্য যোগ করুন
                        </button>
                        <div id="product-master-list" style="margin-top: 2rem; display: grid; gap: 1rem;">
                            <!-- Products will be listed here -->
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-database"></i> ডেটা ব্যাকআপ ও ব্যবস্থাপনা</h3>

                        <div class="form-group"
                            style="padding: 1.5rem; background: var(--bg); border-radius: var(--radius-md); border: 1px solid var(--border); margin-bottom: 2rem;">
                            <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-cloud-arrow-down"></i> ব্যাকআপ ডাউনলোড
                                করুন</h4>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">আপনার সমস্ত
                                তথ্য একটি
                                জেসন (JSON) ফাইল হিসেবে সেভ করে রাখুন।</p>
                            <button class="btn btn-primary" onclick="exportBackupData()">
                                <i class="fas fa-download"></i> ব্যাকআপ ডাউনলোড
                            </button>
                        </div>

                        <div class="form-group"
                            style="padding: 1.5rem; background: var(--bg); border-radius: var(--radius-md); border: 1px solid var(--border);">
                            <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-cloud-arrow-up"></i> ডেটা রিস্টোর করুন
                            </h4>
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">সতর্কতা: নতুন
                                ফাইল
                                আপলোড করলে বর্তমান সকল তথ্য মুছে যাবে।</p>
                            <input type="file" id="restoreFile" accept=".json"
                                style="margin-bottom: 1rem; border: 1px dashed var(--border); padding: 1rem; background: var(--card-bg);">
                            <button class="btn btn-danger" onclick="importBackupData()">
                                <i class="fas fa-upload"></i> ডেটা রিস্টোর করুন
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- PDF Template -->
            <div id="pdf-container" style="display: none;">
                <div id="invoice-template"
                    style="padding: 40px; font-family: 'Hind Siliguri', sans-serif; background: #fff; width: 100%; max-width: 800px; color: #1e293b;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #0f172a; padding-bottom: 20px; margin-bottom: 30px;">
                        <div>
                            <h1 id="pdf-shop-name"
                                style="color: #0f172a; margin: 0; font-size: 36px; font-weight: 800;"></h1>
                            <p id="pdf-shop-address" style="margin: 5px 0; font-size: 14px;"></p>
                            <p style="margin: 3px 0; font-size: 16px;"><b>মোবাইল: <span id="pdf-shop-phone"></span></b>
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0; color: #3b82f6; font-size: 24px; text-transform: uppercase;">ইনভয়েস
                                (Invoice)
                            </h2>
                            <p style="margin: 10px 0 0;"><b>নং:</b> <span id="pdf-inv-no"></span></p>
                            <p style="margin: 2px 0;"><b>তারিখ:</b> <span id="pdf-date"></span></p>
                        </div>
                    </div>

                    <div
                        style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <p
                                style="margin: 0 0 5px; color: #64748b; font-size: 12px; text-transform: uppercase; font-weight: bold;">
                                গ্রাহকের তথ্য</p>
                            <p style="margin: 0; font-size: 16px;"><b>নাম:</b> <span id="pdf-cust-name"></span></p>
                            <p style="margin: 3px 0;"><b>মোবাইল:</b> <span id="pdf-cust-mobile"></span></p>
                            <p style="margin: 3px 0;"><b>ঠিকানা:</b> <span id="pdf-cust-address"></span></p>
                        </div>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: #0f172a; color: #fff;">
                                <th style="padding: 12px; text-align: left; border: 1px solid #0f172a;">পণ্যের বিবরণ
                                </th>
                                <th style="padding: 12px; text-align: center; border: 1px solid #0f172a; width: 80px;">
                                    পরিমাণ
                                </th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #0f172a; width: 120px;">
                                    দর</th>
                                <th style="padding: 12px; text-align: right; border: 1px solid #0f172a; width: 150px;">
                                    মোট টাকা
                                </th>
                            </tr>
                        </thead>
                        <tbody id="pdf-items-body"></tbody>
                    </table>

                    <div style="display: flex; justify-content: flex-end;">
                        <div style="width: 300px;">
                            <div
                                style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <span>মোট বিল:</span>
                                <span id="pdf-total" style="font-weight: bold;"></span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <span>জমা:</span>
                                <span id="pdf-paid" style="font-weight: bold; color: #10b981;"></span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; background: #fff1f2; margin-top: 10px; border-radius: 4px; padding: 10px;">
                                <span style="color: #991b1b; font-weight: bold;">বকেয়া:</span>
                                <span id="pdf-due" style="font-weight: 800; color: #ef4444; font-size: 18px;"></span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 80px; display: flex; justify-content: space-between; font-size: 14px;">
                        <div
                            style="text-align: center; width: 200px; border-top: 1.5px solid #1e293b; padding-top: 8px;">
                            গ্রাহকের স্বাক্ষর
                        </div>
                        <div
                            style="text-align: center; width: 200px; border-top: 1.5px solid #1e293b; padding-top: 8px;">
                            কর্তৃপক্ষের স্বাক্ষর
                        </div>
                    </div>

                    <div
                        style="text-align: center; margin-top: 60px; font-size: 11px; color: #94a3b8; border-top: 1px dashed #e2e8f0; padding-top: 20px;">
                        ধন্যবাদ, আবার আসবেন। মা জবা স্টুডিও - ডিজিটাল বিলিং সল্যুশন।
                    </div>
                </div>
            </div>


            <script>
                // --- Core State ---
                let db = {
                    invoices: JSON.parse(localStorage.getItem('joba_invoices')) || [],
                    customers: JSON.parse(localStorage.getItem('joba_customers')) || [],
                    reports: JSON.parse(localStorage.getItem('joba_reports')) || {},
                    settings: JSON.parse(localStorage.getItem('joba_settings')) || {
                        shopName: 'মা জবা স্টুডিও',
                        proprietor: 'জনি সরকার',
                        phone: '০১৮৬৪৯৬৯১৩৮',
                        address: 'হাজী আঃ রহমান সুপার মার্কেট, নিমসার, কুমিল্লা।',
                        email: '',
                        website: '',
                        prefix: 'MJS-',
                        dueDays: '0',
                        dateType: 'today',
                        template: 'classic',
                        paperSize: 'a4',
                        headerText: '',
                        footerText: 'ধন্যবাদ, আবার আসবেন। মা জবা স্টুডিও - ডিজিটাল বিলিং সল্যুশন।',
                        logo: null
                    },
                    products: JSON.parse(localStorage.getItem('joba_products')) || []
                };

                // --- Edit State ---
                let state = {
                    editingId: null,
                    view: 'home-view',
                    theme: localStorage.getItem('joba_theme') || 'light',
                    salesChart: null
                };

                const MONTHS = ['সম্পূর্ণ বছর', 'জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুলাই', 'আগস্ট', 'সেপ্টেম্বর', 'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'];

                // --- Initialization ---
                document.addEventListener('DOMContentLoaded', () => {
                    initApp();
                });

                function initApp() {
                    applyTheme();
                    loadShopSettings();
                    setTodayDate();
                    generateInvoiceID();
                    if (db.invoices.length === 0) addNewItemRow();
                    else addNewItemRow();

                    updateCustomerDatalist();
                    updateProductDatalist();
                    initReportPickers();
                    initDuePickers();
                    renderStats();

                    // Set up search listeners
                    document.getElementById('invoiceSearch')?.addEventListener('input', renderInvoiceList);
                    document.getElementById('customerSearch')?.addEventListener('input', renderCustomerList);
                }

                // --- Theme & Settings ---
                function toggleTheme() {
                    state.theme = state.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('joba_theme', state.theme);
                    applyTheme();
                }

                function applyTheme() {
                    document.documentElement.setAttribute('data-theme', state.theme);
                    const icon = document.querySelector('.theme-toggle i');
                    if (icon) icon.className = state.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                    if (state.salesChart) renderSalesChart(); // Re-render if chart exists
                }

                function loadShopSettings() {
                    document.getElementById('display-shop-name').innerText = db.settings.shopName;
                    document.getElementById('display-proprietor').innerText = db.settings.proprietor;
                    document.getElementById('display-phone').innerText = db.settings.phone;
                    document.getElementById('display-address').innerText = db.settings.address;

                    // Fill inputs with mapping
                    const map = {
                        'shop-name': 'shopName', 'proprietor': 'proprietor', 'phone': 'phone',
                        'email': 'email', 'website': 'website', 'address': 'address',
                        'prefix': 'prefix', 'date-type': 'dateType', 'due-days': 'dueDays',
                        'template-style': 'template', 'paper-size': 'paperSize',
                        'header-text': 'headerText', 'footer-text': 'footerText'
                    };

                    Object.keys(map).forEach(idPart => {
                        const el = document.getElementById('set-' + idPart);
                        if (el) el.value = db.settings[map[idPart]] || '';
                    });

                    // Logo preview
                    if (db.settings.logo) {
                        document.getElementById('logo-preview-container').style.display = 'block';
                        document.getElementById('logo-preview-img').src = db.settings.logo;
                    } else {
                        document.getElementById('logo-preview-container').style.display = 'none';
                    }
                }

                function handleLogoUpload(input) {
                    const file = input.files[0];
                    if (!file) return;
                    if (file.size > 200 * 1024) return alert('লোগো সাইজ ২০০ কেবি এর নিচে হতে হবে।');
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        db.settings.logo = e.target.result;
                        document.getElementById('logo-preview-container').style.display = 'block';
                        document.getElementById('logo-preview-img').src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }

                function removeLogo() {
                    db.settings.logo = null;
                    document.getElementById('logo-preview-container').style.display = 'none';
                    document.getElementById('set-logo-input').value = '';
                }

                function updateShopSettings() {
                    db.settings.shopName = document.getElementById('set-shop-name').value;
                    db.settings.proprietor = document.getElementById('set-proprietor').value;
                    db.settings.phone = document.getElementById('set-phone').value;
                    db.settings.email = document.getElementById('set-email').value;
                    db.settings.website = document.getElementById('set-website').value;
                    db.settings.address = document.getElementById('set-address').value;
                    db.settings.prefix = document.getElementById('set-prefix').value;
                    db.settings.dateType = document.getElementById('set-date-type').value;
                    db.settings.dueDays = document.getElementById('set-due-days').value;
                    db.settings.template = document.getElementById('set-template-style').value;
                    db.settings.paperSize = document.getElementById('set-paper-size').value;
                    db.settings.headerText = document.getElementById('set-header-text').value;
                    db.settings.footerText = document.getElementById('set-footer-text').value;

                    saveToDisk();
                    loadShopSettings();
                    generateInvoiceID();
                    alert('সকল সেটিংস সফলভাবে সেভ করা হয়েছে!');
                }

                // --- Product Master Logic ---
                function addNewProductToMaster() {
                    const name = document.getElementById('new-item-name').value;
                    const price = parseFloat(document.getElementById('new-item-price').value) || 0;
                    if (!name) return alert('পণ্যের নাম দিন');

                    db.products.push({ id: Date.now(), name, price });
                    saveToDisk();
                    renderProductMasterList();
                    updateProductDatalist();
                    document.getElementById('new-item-name').value = '';
                    document.getElementById('new-item-price').value = '';
                }

                function renderProductMasterList() {
                    const container = document.getElementById('product-master-list');
                    if (!container) return;
                    container.innerHTML = '';
                    db.products.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.style.padding = '1rem';
                        div.innerHTML = `
                    <div><b>${p.name}</b><br><small>ডিফল্ট দর: ${p.price.toFixed(2)}</small></div>
                    <button class="btn btn-danger btn-sm" onclick="deleteProductFromMaster(${p.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                        container.appendChild(div);
                    });
                }

                function deleteProductFromMaster(id) {
                    if (!confirm('নিশ্চিত ডিলিট করতে চান?')) return;
                    db.products = db.products.filter(p => p.id !== id);
                    saveToDisk();
                    renderProductMasterList();
                    updateProductDatalist();
                }

                function updateProductDatalist() {
                    const id = 'masterProductList';
                    let list = document.getElementById(id);
                    if (!list) {
                        list = document.createElement('datalist');
                        list.id = id;
                        document.body.appendChild(list);
                    }
                    list.innerHTML = '';
                    db.products.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.name;
                        opt.dataset.price = p.price;
                        list.appendChild(opt);
                    });
                }

                function handleProductSelection(input) {
                    const val = input.value;
                    const product = db.products.find(p => p.name === val);
                    if (product) {
                        const row = input.closest('.item-row');
                        row.querySelector('.item-price').value = product.price;
                        calculateCalculations();
                    }
                }

                function setTodayDate() {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    document.getElementById('invoiceDate').value = `${year}-${month}-${day}`;
                }

                // --- Navigation ---
                function switchView(viewId, element) {
                    state.view = viewId;
                    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                    document.getElementById(viewId).classList.add('active');

                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    element.classList.add('active');

                    if (viewId === 'invoices-view') renderInvoiceList();
                    if (viewId === 'customers-view') renderCustomerList();
                    if (viewId === 'reports-view') renderReports();
                    if (viewId === 'dues-view') renderDueList();
                    if (viewId === 'settings-view') renderProductMasterList();
                }

                // --- Invoice Logic ---
                function generateInvoiceID() {
                    if (state.editingId) return;
                    const prefix = db.settings.prefix || 'INV-';
                    const now = new Date();
                    const datePrefix = now.toISOString().slice(0, 10).replace(/-/g, '');
                    const todayInvoices = db.invoices.filter(inv => inv.date === now.toISOString().slice(0, 10));
                    const count = todayInvoices.length + 1;
                    const id = `${prefix}${datePrefix}-${String(count).padStart(3, '0')}`;
                    document.getElementById('invoiceNo').value = id;
                }

                function addNewItemRow(data = {}) {
                    const container = document.getElementById('items-container');
                    const row = document.createElement('div');
                    row.className = 'item-row';
                    row.innerHTML = `
                <div>
                    <input type="text" placeholder="পণ্যের নাম/বিবরণ" class="item-name" 
                        list="masterProductList" onchange="handleProductSelection(this)" value="${data.name || ''}">
                </div>
                <input type="number" placeholder="Qty" class="item-qty" oninput="calculateCalculations()" value="${data.qty || 1}">
                <input type="number" placeholder="দর" class="item-price" oninput="calculateCalculations()" value="${data.price || ''}">
                <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculateCalculations()" title="মুছে ফেলুন">
                    <i class="fas fa-trash-can"></i>
                </button>
            `;
                    container.appendChild(row);
                }

                function calculateCalculations() {
                    let total = 0;
                    const rows = document.querySelectorAll('.item-row');

                    rows.forEach(row => {
                        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                        const price = parseFloat(row.querySelector('.item-price').value) || 0;
                        total += (qty * price);
                    });

                    document.getElementById('grandTotalDisplay').innerText = total.toFixed(2);

                    const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
                    const due = total - paid;

                    const dueEl = document.getElementById('dueAmount');
                    dueEl.innerText = due.toFixed(2);
                    dueEl.style.color = due > 0 ? 'var(--danger)' : 'var(--success)';

                    return { total, paid, due };
                }

                function handleCustomerSelection(val) {
                    const match = db.customers.find(c => `${c.name} (${c.mobile})` === val || c.name === val);
                    if (match) {
                        document.getElementById('customerName').value = match.name;
                        document.getElementById('customerMobile').value = match.mobile;
                        document.getElementById('customerAddress').value = match.address || '';
                    }
                }

                function updateCustomerDatalist() {
                    const list = document.getElementById('customerList');
                    if (!list) return;
                    list.innerHTML = '';
                    db.customers.forEach(c => {
                        const option = document.createElement('option');
                        option.value = `${c.name} (${c.mobile})`;
                        list.appendChild(option);
                    });
                }

                // --- Due List Logic ---
                function initDuePickers() {
                    const yearSelect = document.getElementById('dueYearSelect');
                    const monthSelect = document.getElementById('dueMonthSelect');
                    if (!yearSelect || !monthSelect) return;

                    const currentYear = new Date().getFullYear();
                    yearSelect.innerHTML = '<option value="">সম্পূর্ণ সময়</option>';
                    for (let i = currentYear; i >= currentYear - 5; i--) {
                        const opt = document.createElement('option');
                        opt.value = i;
                        opt.innerText = i;
                        yearSelect.appendChild(opt);
                    }

                    monthSelect.innerHTML = '';
                    MONTHS.forEach((m, i) => {
                        const opt = document.createElement('option');
                        opt.value = i === 0 ? '' : String(i).padStart(2, '0');
                        opt.innerText = m;
                        monthSelect.appendChild(opt);
                    });

                    monthSelect.value = String(new Date().getMonth() + 1).padStart(2, '0');
                    yearSelect.value = currentYear;
                }

                function renderDueList() {
                    const year = document.getElementById('dueYearSelect').value;
                    const month = document.getElementById('dueMonthSelect').value;
                    const container = document.getElementById('due-list-content');
                    if (!container) return;

                    let filtered = db.invoices.filter(i => {
                        const iY = i.date.slice(0, 4);
                        const iM = i.date.slice(5, 7);
                        return (year === '' || iY === year) && (month === '' || iM === month);
                    });

                    const customerDues = {};
                    filtered.forEach(inv => {
                        if (inv.due > 0) {
                            if (!customerDues[inv.customerMobile]) {
                                customerDues[inv.customerMobile] = {
                                    name: inv.customerName,
                                    phone: inv.customerMobile,
                                    address: inv.customerAddress,
                                    due: 0
                                };
                            }
                            customerDues[inv.customerMobile].due += inv.due;
                        }
                    });

                    const customers = Object.values(customerDues);
                    if (customers.length === 0) {
                        container.innerHTML = `<div style="padding: 3rem; text-align: center; color: var(--text-muted); font-size: 1.1rem;">
                            <i class="fas fa-circle-check" style="font-size: 3rem; display: block; margin-bottom: 1rem; color: var(--success); opacity: 0.5;"></i>
                            এই সময়ের জন্য কোনো বকেয়া নেই।
                        </div>`;
                        return;
                    }

                    let html = `
                        <table class="report-table" style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr style="background: var(--primary); color: white;">
                                    <th style="padding: 15px 12px; text-align: left; border-radius: 8px 0 0 0;">গ্রাহকের নাম ও তথ্য</th>
                                    <th style="padding: 15px 12px; text-align: left;">ঠিকানা</th>
                                    <th style="padding: 15px 12px; text-align: right; border-radius: 0 8px 0 0;">বকেয়া টাকা</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    let totalDue = 0;
                    customers.sort((a, b) => b.due - a.due).forEach(c => {
                        totalDue += c.due;
                        html += `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 15px 12px;">
                                    <div style="font-weight:700; color: var(--primary);">${c.name}</div>
                                    <div style="font-size:0.8rem; color: var(--text-muted);">${c.phone}</div>
                                </td>
                                <td style="padding: 15px 12px; color: var(--text-muted);">${c.address || '-'}</td>
                                <td style="padding: 15px 12px; text-align: right; color: var(--danger); font-weight: 900; font-size: 1.1rem;">${c.due.toFixed(2)} ৳</td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                            <tfoot>
                                <tr style="background: var(--bg); font-weight: 900; border-top: 2px solid var(--primary);">
                                    <td colspan="2" style="padding: 15px 12px; text-align: right; color: var(--primary); font-size: 1.1rem;">সর্বমোট মাসিক বকেয়া:</td>
                                    <td style="padding: 15px 12px; text-align: right; color: var(--danger); font-size: 1.4rem;">${totalDue.toFixed(2)} ৳</td>
                                </tr>
                            </tfoot>
                        </table>`;

                    container.innerHTML = html;
                }

                async function exportDueListPDF() {
                    const year = document.getElementById('dueYearSelect').value;
                    const monthIdx = document.getElementById('dueMonthSelect').value;
                    const monthName = MONTHS[parseInt(monthIdx || 0)];
                    const element = document.getElementById('due-list-content');

                    const opt = {
                        margin: 0.5,
                        filename: `Due_List_${monthName}_${year}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 3, useCORS: true },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };

                    const content = `
                        <div style="font-family: 'Inter', 'Hind Siliguri', sans-serif; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f172a; padding-bottom: 20px; margin-bottom: 30px;">
                                <div>
                                    <h1 style="margin: 0; color: #0f172a;">${db.settings.shopName}</h1>
                                    <p style="margin: 5px 0; color: #64748b;">${db.settings.address}</p>
                                    <p style="margin: 0; color: #64748b;">মোবাইল: ${db.settings.phone}</p>
                                </div>
                                <div style="text-align: right;">
                                    <h2 style="margin: 0; color: #ef4444;">বকেয়া তালিকা</h2>
                                    <p style="margin: 5px 0; font-weight: bold;">${monthName} ${year}</p>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                ${element.innerHTML}
                            </div>
                            <div style="margin-top: 50px; text-align: center; font-size: 10px; color: #94a3b8; border-top: 1px dashed #e2e8f0; padding-top: 20px;">
                                রিপোর্টটি সিস্টেম দ্বারা জেনারেট করা হয়েছে | সময়: ${new Date().toLocaleString('bn-BD')}
                            </div>
                        </div>
                    `;

                    const worker = html2pdf().set(opt).from(content).save();
                }

                // --- Save / Update ---
                async function saveInvoice() {
                    const data = getFormData();
                    if (!data) return;

                    if (state.editingId) {
                        updateExistingInvoice(data);
                    } else {
                        createNewInvoice(data);
                    }

                    saveToDisk();

                    // Generate PDF first
                    await generatePDF(data);

                    // Then reset and alert
                    setTimeout(() => {
                        resetBillForm();
                        alert('সফলভাবে সেভ করা হয়েছে!');
                    }, 500);
                }

                function createNewInvoice(inv) {
                    db.invoices.unshift(inv);
                    updateCustomerEntry(inv, inv.due);
                    updateReportsLogic(inv.date, inv.total, inv.paid, inv.due, true);
                }

                function updateExistingInvoice(newInv) {
                    const index = db.invoices.findIndex(i => i.id === state.editingId);
                    if (index === -1) return;

                    const oldInv = db.invoices[index];
                    updateReportsLogic(oldInv.date, oldInv.total, oldInv.paid, oldInv.due, false);
                    updateCustomerEntry(oldInv, -oldInv.due);

                    db.invoices[index] = newInv;
                    updateCustomerEntry(newInv, newInv.due);
                    updateReportsLogic(newInv.date, newInv.total, newInv.paid, newInv.due, true);
                }

                function updateCustomerEntry(inv, dueDiff) {
                    let customer = db.customers.find(c => c.mobile === inv.customerMobile);
                    if (customer) {
                        customer.totalDue = (customer.totalDue || 0) + dueDiff;
                        customer.lastVisit = inv.date;
                        customer.name = inv.customerName;
                        customer.address = inv.customerAddress;
                        // Update invoice count if it's a new invoice (dueDiff would be inv.due)
                        // However, the current logic calls this on update too. 
                        // Let's refine: Only increment invoiceCount when creating new.
                        // We'll handle this purely by counting invoices later in render if needed, 
                        // but for performance let's store it.
                        if (dueDiff === inv.due && !state.editingId) {
                            customer.invoiceCount = (customer.invoiceCount || 0) + 1;
                        }
                    } else {
                        const customerId = `CUST-${Date.now().toString().slice(-6)}`;
                        db.customers.push({
                            id: customerId,
                            name: inv.customerName,
                            mobile: inv.customerMobile,
                            address: inv.customerAddress,
                            totalDue: dueDiff,
                            lastVisit: inv.date,
                            createdDate: inv.date,
                            invoiceCount: 1
                        });
                    }
                }

                function updateReportsLogic(dateStr, total, paid, due, isAdd) {
                    const year = dateStr.slice(0, 4);
                    const month = dateStr.slice(5, 7);
                    if (!db.reports[year]) db.reports[year] = {};
                    if (!db.reports[year][month]) {
                        db.reports[year][month] = { totalSales: 0, totalDue: 0, totalPaid: 0, totalInvoices: 0 };
                    }
                    const mult = isAdd ? 1 : -1;
                    db.reports[year][month].totalSales += total * mult;
                    db.reports[year][month].totalDue += due * mult;
                    db.reports[year][month].totalPaid += paid * mult;
                    db.reports[year][month].totalInvoices += 1 * mult;
                }

                function getFormData() {
                    const name = document.getElementById('customerName').value;
                    const mobile = document.getElementById('customerMobile').value;
                    const address = document.getElementById('customerAddress').value;
                    const id = document.getElementById('invoiceNo').value;
                    const date = document.getElementById('invoiceDate').value;
                    const paid = parseFloat(document.getElementById('paidAmount').value) || 0;

                    if (!name) { alert('গ্রাহকের নাম দিন'); return null; }
                    if (!mobile) { alert('মোবাইল নম্বর দিন'); return null; }

                    const rows = document.querySelectorAll('.item-row');
                    let items = [];
                    rows.forEach(row => {
                        const itemName = row.querySelector('.item-name').value;
                        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                        const price = parseFloat(row.querySelector('.item-price').value) || 0;
                        if (itemName && qty > 0) {
                            items.push({ name: itemName, qty, price, total: qty * price });
                        }
                    });

                    if (items.length === 0) { alert('অন্তত একটি পণ্য যোগ করুন'); return null; }
                    const total = items.reduce((sum, item) => sum + item.total, 0);
                    return {
                        id, date, customerName: name, customerMobile: mobile, customerAddress: address,
                        items, total, paid, due: total - paid
                    };
                }

                // --- UI Rendering ---
                function renderInvoiceList() {
                    const query = document.getElementById('invoiceSearch').value.toLowerCase();
                    const dateFrom = document.getElementById('filter-date-from').value;
                    const dateTo = document.getElementById('filter-date-to').value;
                    const status = document.getElementById('filter-status').value;
                    const container = document.getElementById('invoice-list-container');

                    container.innerHTML = '';

                    let filtered = db.invoices.filter(i => {
                        const matchesQuery = i.id.toLowerCase().includes(query) ||
                            i.customerName.toLowerCase().includes(query) ||
                            i.customerMobile.includes(query);

                        const matchesDate = (!dateFrom || i.date >= dateFrom) &&
                            (!dateTo || i.date <= dateTo);

                        const matchesStatus = status === 'all' ||
                            (status === 'paid' && i.due <= 0) ||
                            (status === 'due' && i.due > 0);

                        return matchesQuery && matchesDate && matchesStatus;
                    });

                    // Update Summary Stats for the filtered view
                    updateInvoiceSummary(filtered);

                    filtered.forEach(inv => {
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `
                    <div>
                        <div style="font-weight:700; color: var(--primary);">${inv.customerName}</div>
                        <div style="font-size:0.8rem; color: var(--text-muted); margin-top: 2px;">
                            <i class="far fa-id-badge"></i> ${inv.id} | <i class="far fa-calendar"></i> ${inv.date}
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:800; font-size: 1.1rem; color: var(--primary);">${inv.total.toFixed(2)} ৳</div>
                        <div style="margin: 4px 0;">
                            <span class="status-badge ${inv.due > 0 ? 'status-due' : 'status-paid'}">
                                ${inv.due > 0 ? 'বকেয়া: ' + inv.due.toFixed(2) : 'পরিশোধিত'}
                            </span>
                        </div>
                        <div style="display: flex; gap: 5px; justify-content: flex-end; margin-top: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="editInvoice('${inv.id}')" title="এডিট">
                                <i class="fas fa-pen-to-square"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="rePrintInvoice('${inv.id}')" title="প্রিন্ট">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="downloadInvoicePDF('${inv.id}')" title="PDF ডাউনলোড">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${inv.id}')" title="ডিলিট">
                                <i class="fas fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                `;
                        container.appendChild(div);
                    });
                }

                function updateInvoiceSummary(invoices) {
                    const today = new Date().toISOString().slice(0, 10);
                    const thisMonth = today.slice(0, 7);

                    let todayTotal = 0;
                    let monthTotal = 0;
                    let totalDue = 0;

                    invoices.forEach(i => {
                        if (i.date === today) todayTotal += i.total;
                        if (i.date.startsWith(thisMonth)) monthTotal += i.total;
                        totalDue += i.due;
                    });

                    document.getElementById('stats-today-total').innerText = todayTotal.toFixed(2) + ' ৳';
                    document.getElementById('stats-month-total').innerText = monthTotal.toFixed(2) + ' ৳';
                    document.getElementById('stats-total-due').innerText = totalDue.toFixed(2) + ' ৳';
                }

                function exportInvoices(format) {
                    const query = document.getElementById('invoiceSearch').value.toLowerCase();
                    const dateFrom = document.getElementById('filter-date-from').value;
                    const dateTo = document.getElementById('filter-date-to').value;
                    const status = document.getElementById('filter-status').value;

                    let filtered = db.invoices.filter(i => {
                        const matchesQuery = i.id.toLowerCase().includes(query) ||
                            i.customerName.toLowerCase().includes(query) ||
                            i.customerMobile.includes(query);
                        const matchesDate = (!dateFrom || i.date >= dateFrom) && (!dateTo || i.date <= dateTo);
                        const matchesStatus = status === 'all' || (status === 'paid' && i.due <= 0) || (status === 'due' && i.due > 0);
                        return matchesQuery && matchesDate && matchesStatus;
                    });

                    const data = filtered.map(i => ({
                        'Invoice No': i.id,
                        'Date': i.date,
                        'Customer': i.customerName,
                        'Mobile': i.customerMobile,
                        'Total': i.total,
                        'Paid': i.paid,
                        'Due': i.due,
                        'Status': i.due > 0 ? 'Due' : 'Paid'
                    }));

                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Invoices");

                    if (format === 'excel') {
                        XLSX.writeFile(wb, `invoices_${new Date().toISOString().slice(0, 10)}.xlsx`);
                    } else {
                        XLSX.writeFile(wb, `invoices_${new Date().toISOString().slice(0, 10)}.csv`, { bookType: 'csv' });
                    }
                }

                async function downloadInvoicePDF(id) {
                    const inv = db.invoices.find(i => i.id === id);
                    if (inv) {
                        await generatePDF(inv);
                        alert('PDF ডাউনলোড সম্পন্ন হয়েছে!');
                    }
                }

                function renderCustomerList() {
                    const query = document.getElementById('customerSearch').value.toLowerCase();
                    const container = document.getElementById('customer-list-container');
                    container.innerHTML = '';

                    const filtered = db.customers.filter(c =>
                        (c.name && c.name.toLowerCase().includes(query)) ||
                        (c.mobile && c.mobile.includes(query)) ||
                        (c.id && c.id.toLowerCase().includes(query))
                    );

                    filtered.sort((a, b) => b.totalDue - a.totalDue).forEach(cust => {
                        const invCount = db.invoices.filter(i => i.customerMobile === cust.mobile).length;
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                             <span style="font-size: 0.75rem; background: var(--bg); padding: 2px 8px; border-radius: 4px; color: var(--text-muted); font-weight: 600;">
                                ID: ${cust.id || 'N/A'}
                             </span>
                             <span style="font-size: 0.75rem; color: var(--text-muted);">
                                <i class="fas fa-calendar-plus"></i> ${cust.createdDate || cust.lastVisit || 'N/A'}
                             </span>
                        </div>
                        <div style="font-weight:700; color: var(--primary); font-size: 1.1rem;">${cust.name}</div>
                        <div style="font-size:0.9rem; color: var(--text-muted); margin: 4px 0;">
                            <i class="fas fa-phone"></i> ${cust.mobile} | <i class="fas fa-location-dot"></i> ${cust.address || 'ঠিকানা নেই'}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--accent); font-weight: 600;">
                            <i class="fas fa-file-invoice"></i> মোট ইনভয়েস: ${invCount} টি
                        </div>
                    </div>
                    <div style="text-align:right; min-width: 150px;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">মোট বকেয়া</div>
                        <div style="color: var(--danger); font-weight:900; font-size: 1.5rem; margin-bottom: 10px;">${(cust.totalDue || 0).toFixed(2)} ৳</div>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${cust.mobile}')">
                            <i class="fas fa-user-minus"></i> ডিলিট
                        </button>
                    </div>
                `;
                        container.appendChild(div);
                    });
                }

                function renderStats() {
                    let sales = 0, paid = 0, due = 0;
                    db.invoices.forEach(i => { sales += i.total; paid += i.paid; due += i.due; });
                    document.getElementById('total-sales-report').innerText = sales.toFixed(2) + ' ৳';
                    document.getElementById('total-paid-report').innerText = paid.toFixed(2) + ' ৳';
                    document.getElementById('total-due-report').innerText = due.toFixed(2) + ' ৳';
                    document.getElementById('total-invoices-report').innerText = db.invoices.length;
                }

                function editInvoice(id) {
                    const inv = db.invoices.find(i => i.id === id);
                    if (!inv) return;
                    state.editingId = id;
                    switchView('home-view', document.querySelector('.nav-item[onclick*="home-view"]'));
                    document.getElementById('invoiceNo').value = inv.id;
                    document.getElementById('invoiceDate').value = inv.date;
                    document.getElementById('customerName').value = inv.customerName;
                    document.getElementById('customerMobile').value = inv.customerMobile;
                    document.getElementById('customerAddress').value = inv.customerAddress || '';
                    document.getElementById('paidAmount').value = inv.paid;
                    const container = document.getElementById('items-container');
                    container.innerHTML = '';
                    inv.items.forEach(item => addNewItemRow(item));
                    calculateCalculations();
                    const saveBtn = document.getElementById('save-btn');
                    saveBtn.innerHTML = '<i class="fas fa-check-circle"></i> তথ্য আপডেট ও প্রিন্ট করুন';
                    saveBtn.classList.replace('btn-primary', 'btn-warning');
                    document.getElementById('cancel-edit-btn').style.display = 'block';
                }

                function deleteInvoice(id) {
                    if (!confirm('আপনি কি নিশ্চিত?')) return;
                    const inv = db.invoices.find(i => i.id === id);
                    if (!inv) return;
                    updateReportsLogic(inv.date, inv.total, inv.paid, inv.due, false);
                    updateCustomerEntry(inv, -inv.due);
                    db.invoices = db.invoices.filter(i => i.id !== id);
                    saveToDisk();
                    renderInvoiceList();
                    renderStats();
                }

                function deleteCustomer(mobile) {
                    if (db.invoices.some(i => i.customerMobile === mobile)) return alert('বিল থাকায় ডিলিট সম্ভব নয়।');
                    if (!confirm('নিশ্চিত?')) return;
                    db.customers = db.customers.filter(c => c.mobile !== mobile);
                    saveToDisk();
                    renderCustomerList();
                    updateCustomerDatalist();
                }

                function resetBillForm() {
                    state.editingId = null;
                    document.getElementById('customerName').value = '';
                    document.getElementById('customerMobile').value = '';
                    document.getElementById('customerAddress').value = '';
                    document.getElementById('paidAmount').value = '0';
                    document.getElementById('items-container').innerHTML = '';
                    addNewItemRow();
                    setTodayDate();
                    generateInvoiceID();
                    calculateCalculations();
                    const saveBtn = document.getElementById('save-btn');
                    saveBtn.innerHTML = '<i class="fas fa-cloud-arrow-up"></i> বিল সেভ করুন ও প্রিন্ট দিন';
                    saveBtn.classList.replace('btn-warning', 'btn-primary');
                    document.getElementById('cancel-edit-btn').style.display = 'none';
                    updateCustomerDatalist();
                }

                function initReportPickers() {
                    const ySel = document.getElementById('reportYearSelect');
                    const mSel = document.getElementById('reportMonthSelect');
                    const now = new Date();
                    ySel.innerHTML = '<option value="">সম্পূর্ণ সময়</option>';
                    const years = [...new Set(db.invoices.map(i => i.date.slice(0, 4)))];
                    if (!years.includes(String(now.getFullYear()))) years.push(String(now.getFullYear()));
                    years.sort((a, b) => b - a).forEach(y => { ySel.innerHTML += `<option value="${y}">${y}</option>`; });
                    mSel.innerHTML = '';
                    MONTHS.forEach((m, i) => { mSel.innerHTML += `<option value="${i === 0 ? '' : String(i).padStart(2, '0')}">${m}</option>`; });
                    ySel.value = now.getFullYear();
                    mSel.value = String(now.getMonth() + 1).padStart(2, '0');
                }

                function renderReports() {
                    const year = document.getElementById('reportYearSelect').value;
                    const month = document.getElementById('reportMonthSelect').value;
                    let filtered = db.invoices.filter(i => {
                        const iY = i.date.slice(0, 4);
                        const iM = i.date.slice(5, 7);
                        return (year === '' || iY === year) && (month === '' || iM === month);
                    });

                    // --- 1. Summary Stats ---
                    let sales = 0, paid = 0, due = 0, itemsCount = 0, dueInvoices = 0;
                    filtered.forEach(i => {
                        sales += i.total;
                        paid += i.paid;
                        due += i.due;
                        itemsCount += i.items.reduce((acc, it) => acc + (parseFloat(it.qty) || 0), 0);
                        if (i.due > 0) dueInvoices++;
                    });

                    document.getElementById('total-sales-report').innerText = sales.toFixed(2) + ' ৳';
                    document.getElementById('total-paid-report').innerText = paid.toFixed(2) + ' ৳';
                    document.getElementById('total-due-report').innerText = due.toFixed(2) + ' ৳';
                    document.getElementById('total-invoices-report').innerText = filtered.length;

                    document.getElementById('avg-invoice-val').innerText = `গড় বিল: ${(filtered.length ? sales / filtered.length : 0).toFixed(2)} ৳`;
                    document.getElementById('paid-percentage').innerText = `পরিশোধ হার: ${(sales ? (paid / sales) * 100 : 0).toFixed(1)}%`;
                    document.getElementById('overdue-count').innerText = `বকেয়া বিল: ${dueInvoices} টি`;
                    document.getElementById('total-items-sold').innerText = `বিক্রিত পণ্য: ${itemsCount} টি`;

                    document.getElementById('report-period-label').innerText = (month ? MONTHS[parseInt(month)] : '') + ' ' + (year || 'সম্পূর্ণ সময়');

                    // --- 2. Detailed Invoice Table ---
                    const detailedContainer = document.getElementById('detailed-invoice-report-container');
                    let detHtml = `<table style="width:100%; border-collapse: collapse; font-size: 0.85rem;">
                <thead><tr style="background: var(--primary); color: white;">
                    <th style="padding: 12px; text-align: left;">তারিখ ও নং</th>
                    <th style="padding: 12px; text-align: left;">গ্রাহক</th>
                    <th style="padding: 12px; text-align: right;">মোট</th>
                    <th style="padding: 12px; text-align: right;">জমা</th>
                    <th style="padding: 12px; text-align: right;">বকেয়া</th>
                    <th style="padding: 12px; text-align: center;">স্ট্যাটাস</th>
                </tr></thead><tbody>`;

                    filtered.forEach(inv => {
                        const status = inv.due <= 0 ? 'পরিশোধিত' : (inv.paid > 0 ? 'আংশিক' : 'বকেয়া');
                        const statusColor = inv.due <= 0 ? 'var(--success)' : (inv.paid > 0 ? 'var(--warning)' : 'var(--danger)');
                        detHtml += `<tr>
                    <td style="padding: 10px; border: 1px solid var(--border);">${inv.date}<br><small>${inv.id}</small></td>
                    <td style="padding: 10px; border: 1px solid var(--border);"><b>${inv.customerName}</b><br><small>${inv.customerMobile}</small></td>
                    <td style="padding: 10px; border: 1px solid var(--border); text-align: right;">${inv.total.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid var(--border); text-align: right;">${inv.paid.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid var(--border); text-align: right;">${inv.due.toFixed(2)}</td>
                    <td style="padding: 10px; border: 1px solid var(--border); text-align: center;">
                        <span style="font-size: 0.7rem; font-weight:800; color: white; background: ${statusColor}; padding: 2px 6px; border-radius: 4px;">${status}</span>
                    </td>
                </tr>`;
                    });
                    detailedContainer.innerHTML = filtered.length ? detHtml + '</tbody></table>' : '<p style="padding:2rem; text-align:center;">তথ্য নেই</p>';

                    // --- 3. Customer Summary ---
                    const clients = {};
                    filtered.forEach(i => {
                        const key = i.customerMobile;
                        if (!clients[key]) clients[key] = { name: i.customerName, mobile: i.customerMobile, total: 0, paid: 0, due: 0, count: 0 };
                        clients[key].total += i.total; clients[key].paid += i.paid; clients[key].due += i.due; clients[key].count++;
                    });
                    const clientReportContainer = document.getElementById('client-report-container');
                    let clientHtml = '<table style="width:100%; border-collapse: collapse; font-size: 0.85rem;"><thead><tr style="background: var(--primary-light); color: white;"><th style="padding: 10px; text-align: left;">গ্রাহক</th><th style="padding: 10px; text-align: right;">মোট</th><th style="padding: 10px; text-align: right;">বকেয়া</th></tr></thead><tbody>';
                    Object.values(clients).sort((a, b) => b.total - a.total).slice(0, 10).forEach(c => {
                        clientHtml += `<tr><td style="padding: 8px; border: 1px solid var(--border);"><b>${c.name}</b></td><td style="padding: 8px; border: 1px solid var(--border); text-align: right;">${c.total.toFixed(2)}</td><td style="padding: 8px; border: 1px solid var(--border); text-align: right; color: var(--danger);">${c.due.toFixed(2)}</td></tr>`;
                    });
                    clientReportContainer.innerHTML = Object.keys(clients).length ? clientHtml + '</tbody></table>' : '<p style="padding:1rem;">তথ্য নেই</p>';

                    // --- 4. Product Summary ---
                    const prodsMap = {};
                    filtered.forEach(inv => {
                        inv.items.forEach(item => {
                            if (!prodsMap[item.name]) prodsMap[item.name] = { qty: 0, value: 0 };
                            prodsMap[item.name].qty += parseFloat(item.qty) || 0;
                            prodsMap[item.name].value += parseFloat(item.total) || 0;
                        });
                    });
                    const prodContainer = document.getElementById('product-summary-container');
                    let prodHtml = '<table style="width:100%; border-collapse: collapse; font-size: 0.85rem;"><thead><tr style="background: var(--primary-light); color: white;"><th style="padding: 10px; text-align: left;">পণ্য</th><th style="padding: 10px; text-align: center;">পরিমাণ</th><th style="padding: 10px; text-align: right;">ভ্যালু</th></tr></thead><tbody>';
                    Object.keys(prodsMap).sort((a, b) => prodsMap[b].value - prodsMap[a].value).slice(0, 10).forEach(name => {
                        const p = prodsMap[name];
                        prodHtml += `<tr><td style="padding: 8px; border: 1px solid var(--border);">${name}</td><td style="padding: 8px; border: 1px solid var(--border); text-align: center;">${p.qty}</td><td style="padding: 8px; border: 1px solid var(--border); text-align: right;">${p.value.toFixed(2)}</td></tr>`;
                    });
                    prodContainer.innerHTML = Object.keys(prodsMap).length ? prodHtml + '</tbody></table>' : '<p style="padding:1rem;">তথ্য নেই</p>';

                    // --- 5. Charts ---
                    renderSalesChart(filtered);
                    renderStatusChart(paid, due);

                    // Update Top 5 Customers List
                    const topList = document.getElementById('top-customers-list');
                    topList.innerHTML = '';
                    db.customers.sort((a, b) => b.totalDue - a.totalDue).slice(0, 5).forEach(c => {
                        if (c.totalDue <= 0) return;
                        topList.innerHTML += `<div class="list-item" style="padding: 0.75rem 1.25rem;"><div><div style="font-weight:700;">${c.name}</div><div style="font-size:0.75rem; color: var(--text-muted);">${c.mobile}</div></div><div style="text-align: right;"><div style="color: var(--danger); font-weight:800;">${c.totalDue.toFixed(2)} ৳</div></div></div>`;
                    });
                }

                function renderSalesChart(data = db.invoices) {
                    const canvas = document.getElementById('salesChart');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    if (state.salesChart) state.salesChart.destroy();

                    const sorted = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const last15 = sorted.slice(-15);
                    const labels = last15.map(i => i.date);
                    const values = last15.map(i => i.total);

                    const isDark = state.theme === 'dark';
                    const color = isDark ? '#3b82f6' : '#2563eb';

                    state.salesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'বিক্রয় (৳)',
                                data: values,
                                borderColor: color,
                                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 3,
                                pointBackgroundColor: color,
                                pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)' }, ticks: { color: isDark ? '#94a3b8' : '#64748b' } },
                                x: { grid: { display: false }, ticks: { color: isDark ? '#94a3b8' : '#64748b' } }
                            }
                        }
                    });
                }

                function renderStatusChart(paid, due) {
                    const canvas = document.getElementById('statusChart');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');

                    if (window.myStatusChart) window.myStatusChart.destroy();

                    window.myStatusChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['পরিশোধিত', 'বকেয়া'],
                            datasets: [{
                                data: [paid, due],
                                backgroundColor: ['#059669', '#dc2626'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { color: state.theme === 'dark' ? '#94a3b8' : '#64748b', boxWidth: 12 } }
                            },
                            cutout: '70%'
                        }
                    });
                }

                function saveToDisk() {
                    localStorage.setItem('joba_invoices', JSON.stringify(db.invoices));
                    localStorage.setItem('joba_customers', JSON.stringify(db.customers));
                    localStorage.setItem('joba_reports', JSON.stringify(db.reports));
                    localStorage.setItem('joba_settings', JSON.stringify(db.settings));
                    localStorage.setItem('joba_products', JSON.stringify(db.products));
                }

                function exportBackupData() {
                    const data = { db, timestamp: new Date().toISOString() };
                    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().slice(0, 10)}.json`; a.click();
                }

                function importBackupData() {
                    const file = document.getElementById('restoreFile').files[0];
                    if (!file || !confirm('নিশ্চিত?')) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const imported = JSON.parse(e.target.result);
                        if (imported.db) { db = imported.db; saveToDisk(); location.reload(); }
                    };
                    reader.readAsText(file);
                }

                function rePrintInvoice(id) {
                    const inv = db.invoices.find(i => i.id === id);
                    if (inv) generatePDF(inv);
                }

                function generatePDF(inv) {
                    return new Promise((resolve) => {
                        // Fill shop info from settings
                        document.getElementById('pdf-shop-name').innerText = db.settings.shopName;
                        document.getElementById('pdf-shop-address').innerText = db.settings.address;
                        document.getElementById('pdf-shop-phone').innerText = db.settings.phone;

                        document.getElementById('pdf-inv-no').innerText = inv.id;
                        document.getElementById('pdf-date').innerText = inv.date;
                        document.getElementById('pdf-cust-name').innerText = inv.customerName;
                        document.getElementById('pdf-cust-mobile').innerText = inv.customerMobile;
                        document.getElementById('pdf-cust-address').innerText = inv.customerAddress || 'N/A';
                        const tbody = document.getElementById('pdf-items-body');
                        tbody.innerHTML = '';
                        inv.items.forEach(item => {
                            tbody.innerHTML += `<tr><td style="padding: 12px; border: 1px solid #e2e8f0;">${item.name}</td><td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${item.qty}</td><td style="padding: 12px; border: 1px solid #e2e8f0; text-align: right;">${item.price.toFixed(2)}</td><td style="padding: 12px; border: 1px solid #e2e8f0; text-align: right; font-weight: bold;">${item.total.toFixed(2)}</td></tr>`;
                        });
                        document.getElementById('pdf-total').innerText = inv.total.toFixed(2) + ' ৳';
                        document.getElementById('pdf-paid').innerText = inv.paid.toFixed(2) + ' ৳';
                        document.getElementById('pdf-due').innerText = inv.due.toFixed(2) + ' ৳';

                        const element = document.getElementById('invoice-template');
                        const opt = {
                            margin: 0.3,
                            filename: `${inv.id}.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: {
                                scale: 3,
                                useCORS: true,
                                letterRendering: true,
                                scrollY: 0 // Prevents the content shift issue
                            },
                            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                        };

                        const pdfContainer = document.getElementById('pdf-container');
                        pdfContainer.style.display = 'block';

                        // Give the browser 150ms to ensure the container is rendered and sized
                        setTimeout(() => {
                            html2pdf().set(opt).from(element).save().then(() => {
                                pdfContainer.style.display = 'none';
                                resolve();
                            });
                        }, 150);
                    });
                }
            </script>


</body>

</html>