<!DOCTYPE html>
<html lang="bn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>মা জবা স্টুডিও - বিলিং অ্যাপ</title>

    <link rel="icon" href="favicon.ico">

    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #0f172a;
            --primary-light: #1e293b;
            --accent: #2563eb;
            --accent-glow: rgba(37, 99, 235, 0.4);
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --bg: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: rgba(226, 232, 240, 0.8);
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -4px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --primary: #f8fafc;
            --primary-light: #e2e8f0;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.95);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(51, 65, 85, 0.8);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Hind Siliguri', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg);
            background-image:
                radial-gradient(at 0% 0%, rgba(37, 99, 235, 0.03) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(5, 150, 105, 0.03) 0px, transparent 50%);
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            background: #0f172a;
            color: white;
            padding: 4rem 1rem 6rem;
            text-align: center;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("https://www.transparenttextures.com/patterns/carbon-fibre.png");
            opacity: 0.05;
        }

        header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 0.75rem;
            letter-spacing: -0.04em;
            background: linear-gradient(to bottom right, #ffffff 30%, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            font-size: 1.1rem;
            color: #94a3b8;
            max-width: 600px;
            margin: 0.4rem auto;
            opacity: 0.9;
        }

        .theme-toggle {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(15deg);
        }

        /* --- Container --- */
        .container {
            max-width: 1100px;
            margin: -4rem auto 4rem;
            padding: 0 1.5rem;
            position: relative;
            z-index: 10;
        }

        /* --- Navigation --- */
        .top-tabs-wrapper {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 2.5rem;
            box-shadow: var(--shadow-lg);
            padding: 0.6rem;
        }

        .top-tabs {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .top-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-item {
            flex: 1;
            min-width: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.85rem 0.5rem;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-muted);
            font-weight: 600;
            gap: 0.5rem;
        }

        .nav-item i {
            font-size: 1.35rem;
            transition: transform 0.3s;
        }

        .nav-item:hover i {
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
            box-shadow: var(--shadow);
        }

        /* --- Card --- */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            animation: cardEnter 0.5s ease-out;
        }

        @keyframes cardEnter {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card h3 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            letter-spacing: -0.02em;
        }

        /* --- Forms --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .form-group {
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.85rem 1.25rem;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: var(--bg);
            transition: all 0.3s;
            color: var(--text-main);
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card-bg);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        /* --- Items Table --- */
        .item-row {
            display: grid;
            grid-template-columns: 1fr 100px 140px 50px;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-end;
            padding: 1rem;
            background: var(--bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        /* --- Buttons --- */
        .btn {
            padding: 0.85rem 1.75rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            letter-spacing: -0.01em;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #1d4ed8);
            color: white;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--accent-glow);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text-main);
            border: 1.5px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--card-bg);
            border-color: var(--text-muted);
        }

        .btn-danger {
            background: #fef2f2;
            color: var(--danger);
            border: 1.5px solid #fee2e2;
        }

        [data-theme="dark"] .btn-danger {
            background: rgba(220, 38, 38, 0.1);
            border-color: rgba(220, 38, 38, 0.2);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        /* --- Total Section --- */
        .total-section {
            background: var(--bg);
            border-radius: var(--radius-md);
            padding: 2rem;
            margin-top: 3rem;
            border: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 350px;
            align-items: center;
            font-weight: 600;
        }

        .total-row.grand-total {
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--primary);
            border-top: 2px dashed var(--border);
            padding-top: 1rem;
            margin-top: 0.5rem;
        }

        /* --- Lists --- */
        .list-item {
            background: var(--card-bg);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .list-item:hover {
            border-color: var(--accent);
            transform: translateX(8px);
            box-shadow: var(--shadow-lg);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 800;
        }

        .status-paid {
            background: #dcfce7;
            color: #166534;
        }

        .status-due {
            background: #fee2e2;
            color: #991b1b;
        }

        /* --- View Sections --- */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .view-section.active {
            display: block;
            opacity: 1;
        }

        /* --- Stats Card --- */
        .stat-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent);
            opacity: 0.5;
        }

        /* --- Chart Container --- */
        .chart-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
        }

        /* --- Mobile --- */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2.25rem;
            }

            .container {
                margin-top: -3rem;
                padding: 0 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .item-row {
                grid-template-columns: 1fr;
            }

            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1.5rem;
            }
        }
    </style>


</head>

<body>

    <header>
        <button class="theme-toggle" onclick="toggleTheme()" title="থিম পরিবর্তন করুন">
            <i class="fas fa-moon"></i>
        </button>
        <div style="position: relative; z-index: 2;">
            <h1 id="display-shop-name">মা জবা স্টুডিও</h1>
            <p><i class="fas fa-user-tie"></i> প্রোপাইটর: <span id="display-proprietor">জনি সরকার</span></p>
            <p><i class="fas fa-map-marker-alt"></i> <span id="display-address">হাজী আঃ রহমান সুপার মার্কেট, নিমসার,
                    বুড়িচং, কুমিল্লা।</span></p>
            <p><i class="fas fa-phone"></i> <span id="display-phone">০১৮৬৪৯৬৯১৩৮</span></p>
        </div>
    </header>

    <div class="container">
        <div class="top-tabs-wrapper">
            <div class="top-tabs">
                <div class="nav-item active" onclick="switchView('home-view', this)">
                    <i class="fas fa-plus-circle"></i>
                    <span>বিল তৈরি</span>
                </div>
                <div class="nav-item" onclick="switchView('invoices-view', this)">
                    <i class="fas fa-receipt"></i>
                    <span>সকল ইনভয়েস</span>
                </div>
                <div class="nav-item" onclick="switchView('customers-view', this)">
                    <i class="fas fa-user-group"></i>
                    <span>গ্রাহক তালিকা</span>
                </div>
                <div class="nav-item" onclick="switchView('reports-view', this)">
                    <i class="fas fa-chart-pie"></i>
                    <span>রিপোর্ট</span>
                </div>
                <div class="nav-item" onclick="switchView('settings-view', this)">
                    <i class="fas fa-sliders"></i>
                    <span>সেটিংস</span>
                </div>
            </div>
        </div>

        <div id="home-view" class="view-section active">
            <div class="card">
                <h3><i class="fas fa-file-invoice"></i> নতুন বিল তৈরি করুন</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label>ইনভয়েস নং (অটো):</label>
                        <input type="text" id="invoiceNo" readonly>
                    </div>
                    <div class="form-group">
                        <label>ইনভয়েস তারিখ:</label>
                        <input type="date" id="invoiceDate">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label>গ্রাহকের নাম:</label>
                        <input type="text" id="customerName" placeholder="নাম লিখুন" list="customerList"
                            oninput="handleCustomerSelection(this.value)">
                        <datalist id="customerList"></datalist>
                    </div>
                    <div class="form-group">
                        <label>মোবাইল নম্বর:</label>
                        <input type="tel" id="customerMobile" placeholder="যেমন: 01700000000">
                    </div>
                    <div class="form-group">
                        <label>ঠিকানা:</label>
                        <input type="text" id="customerAddress" placeholder="যেমন: নিমসার, কুমিল্লা">
                    </div>
                </div>

                <div style="margin: 2rem 0 1rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">
                    <h4 style="color: var(--primary); font-size: 1rem;"><i class="fas fa-list-check"></i> পণ্যের বিবরণ
                    </h4>
                </div>

                <div id="items-container">
                    <!-- Rows will be added here -->
                </div>

                <button class="btn btn-secondary btn-sm" onclick="addNewItemRow()" style="margin-bottom: 2rem;">
                    <i class="fas fa-plus"></i> আরো পণ্য যোগ করুন
                </button>

                <div class="total-section">
                    <div class="total-row">
                        <span>মোট বিল:</span>
                        <span id="grandTotalDisplay">0.00</span>
                    </div>
                    <div class="total-row">
                        <span>জমা:</span>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <input type="number" id="paidAmount" value="0"
                                style="width: 120px; padding: 0.5rem; text-align: right;"
                                oninput="calculateCalculations()">
                        </div>
                    </div>
                    <div class="total-row grand-total">
                        <span>বকেয়া:</span>
                        <span id="dueAmount" class="due-amount">0.00</span>
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <button id="save-btn" class="btn btn-primary btn-full" onclick="saveInvoice()">
                        <i class="fas fa-cloud-arrow-up"></i> বিল সেভ করুন ও প্রিন্ট দিন
                    </button>
                    <button id="cancel-edit-btn" class="btn btn-secondary btn-full"
                        style="display:none; margin-top: 0.5rem;" onclick="resetBillForm()">
                        <i class="fas fa-times"></i> বাতিল করুন
                    </button>
                </div>
            </div>
        </div>


        <div id="invoices-view" class="view-section">
            <div class="card">
                <h3><i class="fas fa-file-lines"></i> সকল ইনভয়েস</h3>
                <div class="form-group">
                    <input type="text" id="invoiceSearch" placeholder="ইনভয়েস নং বা নাম দিয়ে খুঁজুন..."
                        oninput="renderInvoiceList()">
                </div>
                <div id="invoice-list-container" class="list-container"></div>
            </div>
        </div>

        <div id="customers-view" class="view-section">
            <div class="card">
                <h3><i class="fas fa-user-tag"></i> গ্রাহক তালিকা ও বকেয়া</h3>
                <div class="form-group">
                    <input type="text" id="customerSearch" placeholder="নাম বা মোবাইল দিয়ে খুঁজুন..."
                        oninput="renderCustomerList()">
                </div>
                <div id="customer-list-container" class="list-container"></div>
            </div>
        </div>

        <div id="reports-view" class="view-section">
            <div class="card">
                <h3><i class="fas fa-chart-column"></i> ব্যবসায়িক রিপোর্ট</h3>

                <div class="form-grid">
                    <div class="form-group">
                        <label>বছর নির্বাচন করুন:</label>
                        <select id="reportYearSelect" onchange="renderReports()"></select>
                    </div>
                    <div class="form-group">
                        <label>মাস নির্বাচন করুন:</label>
                        <select id="reportMonthSelect" onchange="renderReports()"></select>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>মোট বিক্রয়</h4>
                        <h2 id="total-sales-report">0.00 ৳</h2>
                    </div>
                    <div class="stat-card">
                        <h4>মোট পরিশোধ</h4>
                        <h2 id="total-paid-report" style="color: var(--success);">0.00 ৳</h2>
                    </div>
                    <div class="stat-card">
                        <h4>মোট বকেয়া</h4>
                        <h2 id="total-due-report" style="color: var(--danger);">0.00 ৳</h2>
                    </div>
                    <div class="stat-card">
                        <h4>মোট ইনভয়েস</h4>
                        <h2 id="total-invoices-report">0</h2>
                    </div>
                </div>

                <div class="chart-container">
                    <h4 style="margin-bottom: 1.5rem;"><i class="fas fa-chart-line"></i> বিক্রয় একনজরে</h4>
                    <canvas id="salesChart" height="100"></canvas>
                </div>

                <div style="margin-top: 3rem;">
                    <h4 style="margin-bottom: 1.5rem;"><i class="fas fa-users-viewfinder"></i> গ্রাহকভিত্তিক রিপোর্ট
                        (<span id="client-report-period-name">সম্পূর্ণ সময়</span>)</h4>
                    <div id="client-report-container" style="overflow-x: auto;"></div>
                </div>

                <div style="margin-top: 3rem;">
                    <h4 style="margin-bottom: 1rem;"><i class="fas fa-crown"></i> শীর্ষ ৫ বকেয়া গ্রাহক</h4>
                    <div id="top-customers-list" class="list-container"></div>
                </div>
            </div>
        </div>

        <div id="settings-view" class="view-section">
            <div class="card">
                <h3><i class="fas fa-store"></i> দোকানের তথ্য সেটিংস</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>দোকানের নাম:</label>
                        <input type="text" id="set-shop-name" placeholder="যেমন: মা জবা স্টুডিও">
                    </div>
                    <div class="form-group">
                        <label>প্রোপাইটর:</label>
                        <input type="text" id="set-proprietor" placeholder="যেমন: জনি সরকার">
                    </div>
                    <div class="form-group">
                        <label>মোবাইল নম্বর:</label>
                        <input type="tel" id="set-phone" placeholder="০১৮XXXXXXXX">
                    </div>
                    <div class="form-group">
                        <label>ঠিকানা:</label>
                        <input type="text" id="set-address" placeholder="নিমসার, বুড়িচং, কুমিল্লা।">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="updateShopSettings()">
                    <i class="fas fa-save"></i> সেটিংস সেভ করুন
                </button>
            </div>

            <div class="card">
                <h3><i class="fas fa-box-archive"></i> পণ্য/সার্ভিস ম্যানেজমেন্ট</h3>
                <div class="form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>পণ্যের নাম:</label>
                        <input type="text" id="new-item-name" placeholder="পণ্যের নাম লিখুন">
                    </div>
                    <div class="form-group">
                        <label>ডিফল্ট দর (Price):</label>
                        <input type="number" id="new-item-price" placeholder="0.00">
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addNewProductToMaster()">
                    <i class="fas fa-plus"></i> নতুন পণ্য যোগ করুন
                </button>
                <div id="product-master-list" style="margin-top: 2rem; display: grid; gap: 1rem;">
                    <!-- Products will be listed here -->
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-database"></i> ডেটা ব্যাকআপ ও ব্যবস্থাপনা</h3>

                <div class="form-group"
                    style="padding: 1.5rem; background: var(--bg); border-radius: var(--radius-md); border: 1px solid var(--border); margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-cloud-arrow-down"></i> ব্যাকআপ ডাউনলোড করুন</h4>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">আপনার সমস্ত তথ্য একটি
                        জেসন (JSON) ফাইল হিসেবে সেভ করে রাখুন।</p>
                    <button class="btn btn-primary" onclick="exportBackupData()">
                        <i class="fas fa-download"></i> ব্যাকআপ ডাউনলোড
                    </button>
                </div>

                <div class="form-group"
                    style="padding: 1.5rem; background: var(--bg); border-radius: var(--radius-md); border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-cloud-arrow-up"></i> ডেটা রিস্টোর করুন</h4>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">সতর্কতা: নতুন ফাইল
                        আপলোড করলে বর্তমান সকল তথ্য মুছে যাবে।</p>
                    <input type="file" id="restoreFile" accept=".json"
                        style="margin-bottom: 1rem; border: 1px dashed var(--border); padding: 1rem; background: var(--card-bg);">
                    <button class="btn btn-danger" onclick="importBackupData()">
                        <i class="fas fa-upload"></i> ডেটা রিস্টোর করুন
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- PDF Template -->
    <div id="pdf-container" style="display: none;">
        <div id="invoice-template"
            style="padding: 40px; font-family: 'Hind Siliguri', sans-serif; background: #fff; width: 100%; max-width: 800px; color: #1e293b;">
            <div
                style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #0f172a; padding-bottom: 20px; margin-bottom: 30px;">
                <div>
                    <h1 id="pdf-shop-name" style="color: #0f172a; margin: 0; font-size: 36px; font-weight: 800;"></h1>
                    <p id="pdf-shop-address" style="margin: 5px 0; font-size: 14px;"></p>
                    <p style="margin: 3px 0; font-size: 16px;"><b>মোবাইল: <span id="pdf-shop-phone"></span></b></p>
                </div>
                <div style="text-align: right;">
                    <h2 style="margin: 0; color: #3b82f6; font-size: 24px; text-transform: uppercase;">ইনভয়েস (Invoice)
                    </h2>
                    <p style="margin: 10px 0 0;"><b>নং:</b> <span id="pdf-inv-no"></span></p>
                    <p style="margin: 2px 0;"><b>তারিখ:</b> <span id="pdf-date"></span></p>
                </div>
            </div>

            <div
                style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <p
                        style="margin: 0 0 5px; color: #64748b; font-size: 12px; text-transform: uppercase; font-weight: bold;">
                        গ্রাহকের তথ্য</p>
                    <p style="margin: 0; font-size: 16px;"><b>নাম:</b> <span id="pdf-cust-name"></span></p>
                    <p style="margin: 3px 0;"><b>মোবাইল:</b> <span id="pdf-cust-mobile"></span></p>
                    <p style="margin: 3px 0;"><b>ঠিকানা:</b> <span id="pdf-cust-address"></span></p>
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead>
                    <tr style="background: #0f172a; color: #fff;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #0f172a;">পণ্যের বিবরণ</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #0f172a; width: 80px;">পরিমাণ
                        </th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #0f172a; width: 120px;">দর</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #0f172a; width: 150px;">মোট টাকা
                        </th>
                    </tr>
                </thead>
                <tbody id="pdf-items-body"></tbody>
            </table>

            <div style="display: flex; justify-content: flex-end;">
                <div style="width: 300px;">
                    <div
                        style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                        <span>মোট বিল:</span>
                        <span id="pdf-total" style="font-weight: bold;"></span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                        <span>জমা:</span>
                        <span id="pdf-paid" style="font-weight: bold; color: #10b981;"></span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; padding: 12px 0; background: #fff1f2; margin-top: 10px; border-radius: 4px; padding: 10px;">
                        <span style="color: #991b1b; font-weight: bold;">বকেয়া:</span>
                        <span id="pdf-due" style="font-weight: 800; color: #ef4444; font-size: 18px;"></span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 80px; display: flex; justify-content: space-between; font-size: 14px;">
                <div style="text-align: center; width: 200px; border-top: 1.5px solid #1e293b; padding-top: 8px;">
                    গ্রাহকের স্বাক্ষর
                </div>
                <div style="text-align: center; width: 200px; border-top: 1.5px solid #1e293b; padding-top: 8px;">
                    কর্তৃপক্ষের স্বাক্ষর
                </div>
            </div>

            <div
                style="text-align: center; margin-top: 60px; font-size: 11px; color: #94a3b8; border-top: 1px dashed #e2e8f0; padding-top: 20px;">
                ধন্যবাদ, আবার আসবেন। মা জবা স্টুডিও - ডিজিটাল বিলিং সল্যুশন।
            </div>
        </div>
    </div>


    <script>
        // --- Core State ---
        let db = {
            invoices: JSON.parse(localStorage.getItem('joba_invoices')) || [],
            customers: JSON.parse(localStorage.getItem('joba_customers')) || [],
            reports: JSON.parse(localStorage.getItem('joba_reports')) || {},
            settings: JSON.parse(localStorage.getItem('joba_settings')) || {
                shopName: 'মা জবা স্টুডিও',
                proprietor: 'জনি সরকার',
                phone: '০১৮৬৪৯৬৯১৩৮',
                address: 'হাজী আঃ রহমান সুপার মার্কেট, নিমসার, কুমিল্লা।'
            },
            products: JSON.parse(localStorage.getItem('joba_products')) || []
        };

        // --- Edit State ---
        let state = {
            editingId: null,
            view: 'home-view',
            theme: localStorage.getItem('joba_theme') || 'light',
            salesChart: null
        };

        const MONTHS = ['সম্পূর্ণ বছর', 'জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুলাই', 'আগস্ট', 'সেপ্টেম্বর', 'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            applyTheme();
            loadShopSettings();
            setTodayDate();
            generateInvoiceID();
            if (db.invoices.length === 0) addNewItemRow();
            else addNewItemRow();

            updateCustomerDatalist();
            updateProductDatalist();
            initReportPickers();
            renderStats();

            // Set up search listeners
            document.getElementById('invoiceSearch')?.addEventListener('input', renderInvoiceList);
            document.getElementById('customerSearch')?.addEventListener('input', renderCustomerList);
        }

        // --- Theme & Settings ---
        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('joba_theme', state.theme);
            applyTheme();
        }

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', state.theme);
            const icon = document.querySelector('.theme-toggle i');
            if (icon) icon.className = state.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            if (state.salesChart) renderSalesChart(); // Re-render if chart exists
        }

        function loadShopSettings() {
            document.getElementById('display-shop-name').innerText = db.settings.shopName;
            document.getElementById('display-proprietor').innerText = db.settings.proprietor;
            document.getElementById('display-phone').innerText = db.settings.phone;
            document.getElementById('display-address').innerText = db.settings.address;

            // Fill settings inputs
            document.getElementById('set-shop-name').value = db.settings.shopName;
            document.getElementById('set-proprietor').value = db.settings.proprietor;
            document.getElementById('set-phone').value = db.settings.phone;
            document.getElementById('set-address').value = db.settings.address;
        }

        function updateShopSettings() {
            db.settings = {
                shopName: document.getElementById('set-shop-name').value,
                proprietor: document.getElementById('set-proprietor').value,
                phone: document.getElementById('set-phone').value,
                address: document.getElementById('set-address').value
            };
            saveToDisk();
            loadShopSettings();
            alert('সেটিংস সেভ করা হয়েছে!');
        }

        // --- Product Master Logic ---
        function addNewProductToMaster() {
            const name = document.getElementById('new-item-name').value;
            const price = parseFloat(document.getElementById('new-item-price').value) || 0;
            if (!name) return alert('পণ্যের নাম দিন');

            db.products.push({ id: Date.now(), name, price });
            saveToDisk();
            renderProductMasterList();
            updateProductDatalist();
            document.getElementById('new-item-name').value = '';
            document.getElementById('new-item-price').value = '';
        }

        function renderProductMasterList() {
            const container = document.getElementById('product-master-list');
            if (!container) return;
            container.innerHTML = '';
            db.products.forEach(p => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.style.padding = '1rem';
                div.innerHTML = `
                    <div><b>${p.name}</b><br><small>ডিফল্ট দর: ${p.price.toFixed(2)}</small></div>
                    <button class="btn btn-danger btn-sm" onclick="deleteProductFromMaster(${p.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function deleteProductFromMaster(id) {
            if (!confirm('নিশ্চিত ডিলিট করতে চান?')) return;
            db.products = db.products.filter(p => p.id !== id);
            saveToDisk();
            renderProductMasterList();
            updateProductDatalist();
        }

        function updateProductDatalist() {
            const id = 'masterProductList';
            let list = document.getElementById(id);
            if (!list) {
                list = document.createElement('datalist');
                list.id = id;
                document.body.appendChild(list);
            }
            list.innerHTML = '';
            db.products.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.dataset.price = p.price;
                list.appendChild(opt);
            });
        }

        function handleProductSelection(input) {
            const val = input.value;
            const product = db.products.find(p => p.name === val);
            if (product) {
                const row = input.closest('.item-row');
                row.querySelector('.item-price').value = product.price;
                calculateCalculations();
            }
        }

        function setTodayDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('invoiceDate').value = `${year}-${month}-${day}`;
        }

        // --- Navigation ---
        function switchView(viewId, element) {
            state.view = viewId;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            if (viewId === 'invoices-view') renderInvoiceList();
            if (viewId === 'customers-view') renderCustomerList();
            if (viewId === 'reports-view') renderReports();
            if (viewId === 'settings-view') renderProductMasterList();
        }

        // --- Invoice Logic ---
        function generateInvoiceID() {
            if (state.editingId) return;
            const now = new Date();
            const datePrefix = now.toISOString().slice(0, 10).replace(/-/g, '');
            const todayInvoices = db.invoices.filter(inv => inv.date === now.toISOString().slice(0, 10));
            const count = todayInvoices.length + 1;
            const id = `MJS-${datePrefix}-${String(count).padStart(3, '0')}`;
            document.getElementById('invoiceNo').value = id;
        }

        function addNewItemRow(data = {}) {
            const container = document.getElementById('items-container');
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <div>
                    <input type="text" placeholder="পণ্যের নাম/বিবরণ" class="item-name" 
                        list="masterProductList" onchange="handleProductSelection(this)" value="${data.name || ''}">
                </div>
                <input type="number" placeholder="Qty" class="item-qty" oninput="calculateCalculations()" value="${data.qty || 1}">
                <input type="number" placeholder="দর" class="item-price" oninput="calculateCalculations()" value="${data.price || ''}">
                <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculateCalculations()" title="মুছে ফেলুন">
                    <i class="fas fa-trash-can"></i>
                </button>
            `;
            container.appendChild(row);
        }

        function calculateCalculations() {
            let total = 0;
            const rows = document.querySelectorAll('.item-row');

            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                total += (qty * price);
            });

            document.getElementById('grandTotalDisplay').innerText = total.toFixed(2);

            const paid = parseFloat(document.getElementById('paidAmount').value) || 0;
            const due = total - paid;

            const dueEl = document.getElementById('dueAmount');
            dueEl.innerText = due.toFixed(2);
            dueEl.style.color = due > 0 ? 'var(--danger)' : 'var(--success)';

            return { total, paid, due };
        }

        function handleCustomerSelection(val) {
            const match = db.customers.find(c => `${c.name} (${c.mobile})` === val || c.name === val);
            if (match) {
                document.getElementById('customerName').value = match.name;
                document.getElementById('customerMobile').value = match.mobile;
                document.getElementById('customerAddress').value = match.address || '';
            }
        }

        function updateCustomerDatalist() {
            const list = document.getElementById('customerList');
            if (!list) return;
            list.innerHTML = '';
            db.customers.forEach(c => {
                const option = document.createElement('option');
                option.value = `${c.name} (${c.mobile})`;
                list.appendChild(option);
            });
        }

        // --- Save / Update ---
        async function saveInvoice() {
            const data = getFormData();
            if (!data) return;

            if (state.editingId) {
                updateExistingInvoice(data);
            } else {
                createNewInvoice(data);
            }

            saveToDisk();

            // Generate PDF first
            await generatePDF(data);

            // Then reset and alert
            setTimeout(() => {
                resetBillForm();
                alert('সফলভাবে সেভ করা হয়েছে!');
            }, 500);
        }

        function createNewInvoice(inv) {
            db.invoices.unshift(inv);
            updateCustomerEntry(inv, inv.due);
            updateReportsLogic(inv.date, inv.total, inv.paid, inv.due, true);
        }

        function updateExistingInvoice(newInv) {
            const index = db.invoices.findIndex(i => i.id === state.editingId);
            if (index === -1) return;

            const oldInv = db.invoices[index];
            updateReportsLogic(oldInv.date, oldInv.total, oldInv.paid, oldInv.due, false);
            updateCustomerEntry(oldInv, -oldInv.due);

            db.invoices[index] = newInv;
            updateCustomerEntry(newInv, newInv.due);
            updateReportsLogic(newInv.date, newInv.total, newInv.paid, newInv.due, true);
        }

        function updateCustomerEntry(inv, dueDiff) {
            let customer = db.customers.find(c => c.mobile === inv.customerMobile);
            if (customer) {
                customer.totalDue = (customer.totalDue || 0) + dueDiff;
                customer.lastVisit = inv.date;
                customer.name = inv.customerName;
                customer.address = inv.customerAddress;
            } else {
                db.customers.push({
                    name: inv.customerName,
                    mobile: inv.customerMobile,
                    address: inv.customerAddress,
                    totalDue: dueDiff,
                    lastVisit: inv.date
                });
            }
        }

        function updateReportsLogic(dateStr, total, paid, due, isAdd) {
            const year = dateStr.slice(0, 4);
            const month = dateStr.slice(5, 7);
            if (!db.reports[year]) db.reports[year] = {};
            if (!db.reports[year][month]) {
                db.reports[year][month] = { totalSales: 0, totalDue: 0, totalPaid: 0, totalInvoices: 0 };
            }
            const mult = isAdd ? 1 : -1;
            db.reports[year][month].totalSales += total * mult;
            db.reports[year][month].totalDue += due * mult;
            db.reports[year][month].totalPaid += paid * mult;
            db.reports[year][month].totalInvoices += 1 * mult;
        }

        function getFormData() {
            const name = document.getElementById('customerName').value;
            const mobile = document.getElementById('customerMobile').value;
            const address = document.getElementById('customerAddress').value;
            const id = document.getElementById('invoiceNo').value;
            const date = document.getElementById('invoiceDate').value;
            const paid = parseFloat(document.getElementById('paidAmount').value) || 0;

            if (!name) { alert('গ্রাহকের নাম দিন'); return null; }
            if (!mobile) { alert('মোবাইল নম্বর দিন'); return null; }

            const rows = document.querySelectorAll('.item-row');
            let items = [];
            rows.forEach(row => {
                const itemName = row.querySelector('.item-name').value;
                const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
                const price = parseFloat(row.querySelector('.item-price').value) || 0;
                if (itemName && qty > 0) {
                    items.push({ name: itemName, qty, price, total: qty * price });
                }
            });

            if (items.length === 0) { alert('অন্তত একটি পণ্য যোগ করুন'); return null; }
            const total = items.reduce((sum, item) => sum + item.total, 0);
            return {
                id, date, customerName: name, customerMobile: mobile, customerAddress: address,
                items, total, paid, due: total - paid
            };
        }

        // --- UI Rendering ---
        function renderInvoiceList() {
            const query = document.getElementById('invoiceSearch').value.toLowerCase();
            const container = document.getElementById('invoice-list-container');
            container.innerHTML = '';
            const filtered = db.invoices.filter(i =>
                i.id.toLowerCase().includes(query) ||
                i.customerName.toLowerCase().includes(query) ||
                i.customerMobile.includes(query)
            );
            filtered.forEach(inv => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:700; color: var(--primary);">${inv.customerName}</div>
                        <div style="font-size:0.8rem; color: var(--text-muted); margin-top: 2px;">
                            <i class="far fa-id-badge"></i> ${inv.id} | <i class="far fa-calendar"></i> ${inv.date}
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight:800; font-size: 1.1rem; color: var(--primary);">${inv.total.toFixed(2)} ৳</div>
                        <div style="margin: 4px 0;">
                            <span class="status-badge ${inv.due > 0 ? 'status-due' : 'status-paid'}">
                                ${inv.due > 0 ? 'বকেয়া: ' + inv.due.toFixed(2) : 'পরিশোধিত'}
                            </span>
                        </div>
                        <div style="display: flex; gap: 5px; justify-content: flex-end; margin-top: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="editInvoice('${inv.id}')">
                                <i class="fas fa-pen-to-square"></i>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="rePrintInvoice('${inv.id}')">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${inv.id}')">
                                <i class="fas fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderCustomerList() {
            const query = document.getElementById('customerSearch').value.toLowerCase();
            const container = document.getElementById('customer-list-container');
            container.innerHTML = '';
            const filtered = db.customers.filter(c => c.name.toLowerCase().includes(query) || c.mobile.includes(query));
            filtered.sort((a, b) => b.totalDue - a.totalDue).forEach(cust => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight:700; color: var(--primary);">${cust.name}</div>
                        <div style="font-size:0.85rem; color: var(--text-muted);"><i class="fas fa-phone"></i> ${cust.mobile}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="color: var(--danger); font-weight:800; font-size: 1.25rem;">${cust.totalDue.toFixed(2)} ৳</div>
                        <button class="btn btn-danger btn-sm" style="margin-top: 10px;" onclick="deleteCustomer('${cust.mobile}')">
                            <i class="fas fa-user-minus"></i> ডিলিট
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderStats() {
            let sales = 0, paid = 0, due = 0;
            db.invoices.forEach(i => { sales += i.total; paid += i.paid; due += i.due; });
            document.getElementById('total-sales-report').innerText = sales.toFixed(2) + ' ৳';
            document.getElementById('total-paid-report').innerText = paid.toFixed(2) + ' ৳';
            document.getElementById('total-due-report').innerText = due.toFixed(2) + ' ৳';
            document.getElementById('total-invoices-report').innerText = db.invoices.length;
        }

        function editInvoice(id) {
            const inv = db.invoices.find(i => i.id === id);
            if (!inv) return;
            state.editingId = id;
            switchView('home-view', document.querySelector('.nav-item[onclick*="home-view"]'));
            document.getElementById('invoiceNo').value = inv.id;
            document.getElementById('invoiceDate').value = inv.date;
            document.getElementById('customerName').value = inv.customerName;
            document.getElementById('customerMobile').value = inv.customerMobile;
            document.getElementById('customerAddress').value = inv.customerAddress || '';
            document.getElementById('paidAmount').value = inv.paid;
            const container = document.getElementById('items-container');
            container.innerHTML = '';
            inv.items.forEach(item => addNewItemRow(item));
            calculateCalculations();
            const saveBtn = document.getElementById('save-btn');
            saveBtn.innerHTML = '<i class="fas fa-check-circle"></i> তথ্য আপডেট ও প্রিন্ট করুন';
            saveBtn.classList.replace('btn-primary', 'btn-warning');
            document.getElementById('cancel-edit-btn').style.display = 'block';
        }

        function deleteInvoice(id) {
            if (!confirm('আপনি কি নিশ্চিত?')) return;
            const inv = db.invoices.find(i => i.id === id);
            if (!inv) return;
            updateReportsLogic(inv.date, inv.total, inv.paid, inv.due, false);
            updateCustomerEntry(inv, -inv.due);
            db.invoices = db.invoices.filter(i => i.id !== id);
            saveToDisk();
            renderInvoiceList();
            renderStats();
        }

        function deleteCustomer(mobile) {
            if (db.invoices.some(i => i.customerMobile === mobile)) return alert('বিল থাকায় ডিলিট সম্ভব নয়।');
            if (!confirm('নিশ্চিত?')) return;
            db.customers = db.customers.filter(c => c.mobile !== mobile);
            saveToDisk();
            renderCustomerList();
            updateCustomerDatalist();
        }

        function resetBillForm() {
            state.editingId = null;
            document.getElementById('customerName').value = '';
            document.getElementById('customerMobile').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('paidAmount').value = '0';
            document.getElementById('items-container').innerHTML = '';
            addNewItemRow();
            setTodayDate();
            generateInvoiceID();
            calculateCalculations();
            const saveBtn = document.getElementById('save-btn');
            saveBtn.innerHTML = '<i class="fas fa-cloud-arrow-up"></i> বিল সেভ করুন ও প্রিন্ট দিন';
            saveBtn.classList.replace('btn-warning', 'btn-primary');
            document.getElementById('cancel-edit-btn').style.display = 'none';
            updateCustomerDatalist();
        }

        function initReportPickers() {
            const ySel = document.getElementById('reportYearSelect');
            const mSel = document.getElementById('reportMonthSelect');
            const now = new Date();
            ySel.innerHTML = '<option value="">সম্পূর্ণ সময়</option>';
            const years = [...new Set(db.invoices.map(i => i.date.slice(0, 4)))];
            if (!years.includes(String(now.getFullYear()))) years.push(String(now.getFullYear()));
            years.sort((a, b) => b - a).forEach(y => { ySel.innerHTML += `<option value="${y}">${y}</option>`; });
            mSel.innerHTML = '';
            MONTHS.forEach((m, i) => { mSel.innerHTML += `<option value="${i === 0 ? '' : String(i).padStart(2, '0')}">${m}</option>`; });
            ySel.value = now.getFullYear();
            mSel.value = String(now.getMonth() + 1).padStart(2, '0');
        }

        function renderReports() {
            const year = document.getElementById('reportYearSelect').value;
            const month = document.getElementById('reportMonthSelect').value;
            let filtered = db.invoices.filter(i => {
                const iY = i.date.slice(0, 4);
                const iM = i.date.slice(5, 7);
                return (year === '' || iY === year) && (month === '' || iM === month);
            });
            let sales = 0, paid = 0, due = 0;
            filtered.forEach(i => { sales += i.total; paid += i.paid; due += i.due; });
            document.getElementById('total-sales-report').innerText = sales.toFixed(2) + ' ৳';
            document.getElementById('total-paid-report').innerText = paid.toFixed(2) + ' ৳';
            document.getElementById('total-due-report').innerText = due.toFixed(2) + ' ৳';
            document.getElementById('total-invoices-report').innerText = filtered.length;

            renderSalesChart(filtered);

            const clients = {};
            filtered.forEach(i => {
                const key = i.customerMobile;
                if (!clients[key]) clients[key] = { name: i.customerName, mobile: i.customerMobile, total: 0, paid: 0, due: 0, count: 0 };
                clients[key].total += i.total; clients[key].paid += i.paid; clients[key].due += i.due; clients[key].count++;
            });
            const clientReportContainer = document.getElementById('client-report-container');
            document.getElementById('client-report-period-name').innerText = (month ? MONTHS[parseInt(month)] : '') + ' ' + (year || 'সম্পূর্ণ সময়');
            let html = '<table style="width:100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem;"><thead><tr style="background: var(--primary); color: white;"><th style="padding: 10px; text-align: left;">নাম</th><th style="padding: 10px; text-align: right;">মোট</th><th style="padding: 10px; text-align: right;">জমা</th><th style="padding: 10px; text-align: right;">বকেয়া</th><th style="padding: 10px; text-align: center;">বিল</th></tr></thead><tbody>';
            Object.values(clients).sort((a, b) => b.total - a.total).forEach(c => {
                html += `<tr><td style="padding: 8px; border: 1px solid var(--border);"><b>${c.name}</b><br><small>${c.mobile}</small></td><td style="padding: 8px; border: 1px solid var(--border); text-align: right;">${c.total.toFixed(2)}</td><td style="padding: 8px; border: 1px solid var(--border); text-align: right;">${c.paid.toFixed(2)}</td><td style="padding: 8px; border: 1px solid var(--border); text-align: right; color: ${c.due > 0 ? 'var(--danger)' : 'var(--success)'}">${c.due.toFixed(2)}</td><td style="padding: 8px; border: 1px solid var(--border); text-align: center;">${c.count}</td></tr>`;
            });
            clientReportContainer.innerHTML = Object.keys(clients).length ? html + '</tbody></table>' : '<p style="text-align:center; padding: 2rem; color: var(--text-muted);">তথ্য নেই</p>';
            const topList = document.getElementById('top-customers-list');
            topList.innerHTML = '';
            db.customers.sort((a, b) => b.totalDue - a.totalDue).slice(0, 5).forEach(c => {
                if (c.totalDue <= 0) return;
                topList.innerHTML += `<div class="list-item" style="padding: 0.75rem 1.25rem;"><div><div style="font-weight:700;">${c.name}</div><div style="font-size:0.75rem; color: var(--text-muted);">${c.mobile}</div></div><div style="text-align: right;"><div style="color: var(--danger); font-weight:800;">${c.totalDue.toFixed(2)} ৳</div></div></div>`;
            });
        }

        function renderSalesChart(data = db.invoices) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if (state.salesChart) state.salesChart.destroy();

            // Group data by date for the last 15 entries
            const sorted = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
            const last15 = sorted.slice(-15);

            const labels = last15.map(i => i.date);
            const values = last15.map(i => i.total);

            const isDark = state.theme === 'dark';
            const color = isDark ? '#3b82f6' : '#2563eb';

            state.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'বিক্রয় (৳)',
                        data: values,
                        borderColor: color,
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: color,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)' },
                            ticks: { color: isDark ? '#94a3b8' : '#64748b' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: isDark ? '#94a3b8' : '#64748b' }
                        }
                    }
                }
            });
        }

        function saveToDisk() {
            localStorage.setItem('joba_invoices', JSON.stringify(db.invoices));
            localStorage.setItem('joba_customers', JSON.stringify(db.customers));
            localStorage.setItem('joba_reports', JSON.stringify(db.reports));
            localStorage.setItem('joba_settings', JSON.stringify(db.settings));
            localStorage.setItem('joba_products', JSON.stringify(db.products));
        }

        function exportBackupData() {
            const data = { db, timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `backup_${new Date().toISOString().slice(0, 10)}.json`; a.click();
        }

        function importBackupData() {
            const file = document.getElementById('restoreFile').files[0];
            if (!file || !confirm('নিশ্চিত?')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const imported = JSON.parse(e.target.result);
                if (imported.db) { db = imported.db; saveToDisk(); location.reload(); }
            };
            reader.readAsText(file);
        }

        function rePrintInvoice(id) {
            const inv = db.invoices.find(i => i.id === id);
            if (inv) generatePDF(inv);
        }

        function generatePDF(inv) {
            return new Promise((resolve) => {
                // Fill shop info from settings
                document.getElementById('pdf-shop-name').innerText = db.settings.shopName;
                document.getElementById('pdf-shop-address').innerText = db.settings.address;
                document.getElementById('pdf-shop-phone').innerText = db.settings.phone;

                document.getElementById('pdf-inv-no').innerText = inv.id;
                document.getElementById('pdf-date').innerText = inv.date;
                document.getElementById('pdf-cust-name').innerText = inv.customerName;
                document.getElementById('pdf-cust-mobile').innerText = inv.customerMobile;
                document.getElementById('pdf-cust-address').innerText = inv.customerAddress || 'N/A';
                const tbody = document.getElementById('pdf-items-body');
                tbody.innerHTML = '';
                inv.items.forEach(item => {
                    tbody.innerHTML += `<tr><td style="padding: 12px; border: 1px solid #e2e8f0;">${item.name}</td><td style="padding: 12px; border: 1px solid #e2e8f0; text-align: center;">${item.qty}</td><td style="padding: 12px; border: 1px solid #e2e8f0; text-align: right;">${item.price.toFixed(2)}</td><td style="padding: 12px; border: 1px solid #e2e8f0; text-align: right; font-weight: bold;">${item.total.toFixed(2)}</td></tr>`;
                });
                document.getElementById('pdf-total').innerText = inv.total.toFixed(2) + ' ৳';
                document.getElementById('pdf-paid').innerText = inv.paid.toFixed(2) + ' ৳';
                document.getElementById('pdf-due').innerText = inv.due.toFixed(2) + ' ৳';

                const element = document.getElementById('invoice-template');
                const opt = {
                    margin: 0.3,
                    filename: `${inv.id}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 3,
                        useCORS: true,
                        letterRendering: true,
                        scrollY: 0 // Prevents the content shift issue
                    },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                };

                const pdfContainer = document.getElementById('pdf-container');
                pdfContainer.style.display = 'block';

                // Give the browser 150ms to ensure the container is rendered and sized
                setTimeout(() => {
                    html2pdf().set(opt).from(element).save().then(() => {
                        pdfContainer.style.display = 'none';
                        resolve();
                    });
                }, 150);
            });
        }
    </script>


</body>

</html>